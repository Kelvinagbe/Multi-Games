<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #2e7d32;
  --primary-light: #60ad5e;
  --primary-dark: #005005;
  --secondary: #e8f5e9;
  --white: #ffffff;
  --gray: #f5f5f5;
  --dark-gray: #333333;
  --error: #f44336;
  --success: #4caf50;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
  background-color: var(--gray);
  color: var(--dark-gray);
  font-size: 15px;
  line-height: 1.5;
}

.container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

header {
  background-color: var(--primary);
  color: var(--white);
  padding: 15px 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  margin-bottom: 25px;
  border-radius: 0 0 15px 15px;
}

h1 {
  font-size: 24px;
  font-weight: 500;
}

h2 {
  font-size: 20px;
  font-weight: 500;
  margin-bottom: 15px;
}

h3 {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 10px;
}

.card {
  background-color: var(--white);
  border-radius: 15px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
  padding: 20px;
  margin-bottom: 20px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 15px rgba(0, 0, 0, 0.08);
}

.login-card {
  max-width: 400px;
  margin: 40px auto;
}

.input-group {
  margin-bottom: 16px;
}

input, select, textarea {
  width: 100%;
  padding: 10px 16px;
  border: 1px solid #ddd;
  border-radius: 12px;
  font-size: 15px;
  transition: all 0.3s ease;
  background-color: var(--gray);
}

input:focus, select:focus, textarea:focus {
  border-color: var(--primary);
  outline: none;
  box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.15);
  background-color: var(--white);
}

label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  font-size: 14px;
  padding-left: 4px;
}

button {
  background-color: var(--primary);
  color: var(--white);
  border: none;
  padding: 10px 18px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
  font-weight: 500;
  letter-spacing: 0.3px;
}

button:hover {
  background-color: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 3px 8px rgba(0, 80, 5, 0.2);
}

button.secondary {
  background-color: transparent;
  color: var(--primary);
  border: 1px solid var(--primary);
}

button.secondary:hover {
  background-color: var(--secondary);
  box-shadow: 0 3px 8px rgba(46, 125, 50, 0.1);
}

.alert {
  padding: 12px 16px;
  border-radius: 12px;
  margin-bottom: 16px;
  display: none;
  font-size: 14px;
}

.alert-error {
  background-color: #ffebee;
  color: var(--error);
  border: 1px solid #ffcdd2;
}

.alert-success {
  background-color: #e8f5e9;
  color: var(--success);
  border: 1px solid #c8e6c9;
}

.user-card {
  border-left: 3px solid var(--primary);
  margin-bottom: 15px;
  position: relative;
  border-radius: 0 15px 15px 0;
}

.user-card h3 {
  margin-bottom: 8px;
  color: var(--primary-dark);
  display: flex;
  align-items: center;
}

.user-card h3 .user-id {
  font-size: 13px;
  color: #666;
  margin-left: 8px;
  font-weight: normal;
}

.user-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 12px;
}

.user-field {
  margin-bottom: 10px;
}

.field-name {
  font-weight: 500;
  color: #666;
  font-size: 13px;
}

.field-value {
  margin-top: 3px;
  font-size: 14px;
}

.actions {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 80px;
}

.spinner {
  border: 3px solid rgba(0, 0, 0, 0.1);
  border-radius: 50%;
  border-top: 3px solid var(--primary);
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.status-badge {
  display: inline-block;
  padding: 6px 10px;
  border-radius: 12px;
  font-size: 11px;
  margin-left:  10px;
  font-weight: 500;
}

.badge-active {
  background-color: #e8f5e9;
  color: #2e7d32;
}

.badge-inactive {
  background-color: #ffebee;
  color: #c62828;
}

.user-actions {
  position: absolute;
  top: 12px;
  right: 12px;
}

.edit-field {
  display: flex;
  align-items: center;
  gap: 10px;
}

.edit-field input {
  flex: 1;
}

.edit-field button {
  padding: 8px;
  min-width: 32px;
}

.tabs {
  display: flex;
  margin-bottom: 20px;
  border-bottom: 1px solid #ddd;
  overflow: hidden;
  border-radius: 12px 12px 0 0;
  background-color: var(--white);
  padding: 4px;
}

.tab {
  padding: 8px 16px;
  cursor: pointer;
  border-radius: 10px;
  transition: all 0.3s ease;
  margin: 4px;
  font-size: 14px;
}

.tab:hover {
  background-color: var(--secondary);
}

.tab.active {
  background-color: var(--primary);
  color: var(--white);
  font-weight: 500;
}

.tab-content {
  display: none;
  animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.tab-content.active {
  display: block;
}

.search-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
}

.search-bar input {
  flex: 3; /* Extended search bar */
}

.search-bar button {
  flex: 0.5;
}

.dashboard-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 25px;
}

.stat-card {
  padding: 16px;
  border-radius: 15px;
  background-color: var(--white);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
  text-align: center;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 15px rgba(0, 0, 0, 0.08);
}

.stat-card h3 {
  font-size: 14px;
  color: #666;
  margin-bottom: 8px;
}

.stat-card .value {
  font-size: 26px;
  font-weight: 500;
  color: var(--primary);
}

.airtime-history {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid #eee;
}

.history-item {
  display: flex;
  justify-content: space-between;
  padding: 10px 12px;
  border-radius: 10px;
  margin-bottom: 6px;
  transition: background-color 0.3s ease;
}

.history-item:hover {
  background-color: var(--gray);
}

.history-amount {
  font-weight: 500;
  font-size: 14px;
}

.history-date {
  color: #777;
  font-size: 13px;
}

.history-positive {
  color: var(--success);
}

.history-negative {
  color: var(--error);
}

.auth-step {
  display: none;
  animation: fadeIn 0.4s ease;
}

.auth-step.active {
  display: block;
}

.security-progress {
  display: flex;
  margin-bottom: 25px;
  padding: 8px;
}

.progress-step {
  flex: 1;
  text-align: center;
  position: relative;
  padding-bottom: 12px;
}

.progress-step:not(:last-child):after {
  content: '';
  position: absolute;
  top: 8px;
  right: 0;
  width: 50%;
  height: 2px;
  background-color: #ddd;
}

.progress-step:not(:first-child):before {
  content: '';
  position: absolute;
  top: 8px;
  left: 0;
  width: 50%;
  height: 2px;
  background-color: #ddd;
}

.progress-step.completed:after,
.progress-step.completed:before {
  background-color: var(--success);
}

.progress-step.active:after,
.progress-step.active:before {
  background-color: var(--primary);
}

.step-indicator {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background-color: #ddd;
  display: inline-block;
  margin-bottom: 6px;
  transition: all 0.3s ease;
}

.progress-step.completed .step-indicator {
  background-color: var(--success);
}

.progress-step.active .step-indicator {
  background-color: var(--primary);
  transform: scale(1.1);
  box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.15);
}

.progress-step-label {
  font-size: 12px;
  color: #777;
}

.progress-step.active .progress-step-label {
  color: var(--primary);
  font-weight: 500;
}

.progress-step.completed .progress-step-label {
  color: var(--success);
}

/* Added styles for better responsiveness */
@media screen and (max-width: 768px) {
  .user-info {
    grid-template-columns: 1fr;
  }
  
  .dashboard-stats {
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  }
  
  .actions {
    flex-wrap: wrap;
  }
  
  button {
    padding: 8px 14px;
  }
}

/* Additional refinements */
.dropdown-menu {
  width: auto;
  min-width: 150px;
  padding: 6px 0;
  border-radius: 10px;
  background-color: var(--white);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  position: absolute;
  z-index: 100;
}

.dropdown-item {
  padding: 6px 12px;
  font-size: 13px;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.dropdown-item:hover {
  background-color: var(--secondary);
}

/* Submenu buttons - reduced size */
.submenu-button {
  padding: 6px 12px;
  font-size: 13px;
  border-radius: 8px;
}

/* Table styles refinement */
table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

th, td {
  padding: 10px 12px;
  border-bottom: 1px solid #eee;
  font-size: 14px;
  text-align: left;
}

th {
  font-weight: 500;
  color: #666;
  background-color: var(--gray);
  font-size: 13px;
}

tr:last-child td {
  border-bottom: none;
}

tr:hover {
  background-color: var(--gray);
}

/* Pagination styles */
.pagination {
  display: flex;
  justify-content: center;
  gap: 5px;
  margin-top: 20px;
}

.page-item {
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s ease;
}

.page-item:hover {
  background-color: var(--secondary);
}

.page-item.active {
  background-color: var(--primary);
  color: var(--white);
}

.security-alert {
  background-color: #fff;
  border-left: 5px solid #f44336;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 8px;
  transition: all 0.3s ease-in-out;
}

.alert-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 15px;
  font-weight: 600;
  color: #333;
}

.alert-header i {
  color: #f44336;
  margin-right: 10px;
}

.alert-time {
  font-size: 0.9em;
  color: #777;
}

.alert-details {
  margin-bottom: 15px;
}

.alert-field {
  margin-bottom: 8px;
  color: #555;
}

.alert-field strong {
  color: #222;
}

.alert-actions {
  text-align: right;
}

.dismiss-alert {
  background-color: #4caf50;
  color: white;
  border: none;
  padding: 8px 16px;
  font-size: 14px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s ease-in-out;
}

.dismiss-alert:hover {
  background-color: #388e3c;
}

.error-message {
  color: #d32f2f;
  font-style: italic;
}

.high-alert {
  border-left-color: #e53935;
}

.medium-alert {
  border-left-color: #ff9800;
}

.low-alert {
  border-left-color: #03a9f4;
}

/* Green Theme CSS for Device Info Card */
/* Device Management Modal CSS - Enhanced Version */

/* Modal Base Style */
#deviceManagementModal {
  display: none;
  position: fixed;
  z-index: 1000;
  right: 15px;
  top: 15px;
  width: 320px; /* Compact width */
  box-shadow: 0 6px 16px rgba(0,0,0,0.18);
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.3s ease;
  animation: slideIn 0.4s ease-out;
}

/* Modal Content */
.modal-content {
  background-color: #fff;
  border-radius: 8px;
  padding: 0;
  position: relative;
  text-align: center; /* Center align all text content */
}

/* Modal Header */
.modal-content h2 {
  margin: 0;
  padding: 14px 16px;
  background: linear-gradient(135deg, #2e9a4f, #1e7e34); /* Changed blue to green */
  color: white;
  font-size: 16px;
  font-weight: 500;
  border-radius: 8px 8px 0 0;
  display: flex;
  align-items: center;
  justify-content: center; /* Center the heading */
  gap: 8px;
}

.modal-content h2 i {
  font-size: 18px;
  color: #e8f5e9; /* Lighter green for icons */
}

/* Close Button */
.close-modal {
  position: absolute;
  right: 12px;
  top: 10px;
  color: white;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s;
  opacity: 0.8;
}

.close-modal:hover {
  transform: scale(1.1);
  opacity: 1;
}

/* Devices List Container */
.devices-list {
  max-height: 250px;
  overflow-y: auto;
  padding: 8px 0;
}

/* Individual Device Items */
.device-item {
  padding: 12px 16px;
  border-bottom: 1px solid #eaeaea;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: background-color 0.2s;
}

.device-item:hover {
  background-color: #f9fdf9; /* Very light green on hover */
}

.device-item:last-child {
  border-bottom: none;
}

.device-item i {
  color: #2e9a4f; /* Changed to green */
  font-size: 15px;
}

.device-info {
  flex: 1;
  text-align: left; /* Keep device info left-aligned for readability */
  margin-left: 8px; /* Added margin to device info */
}

.device-name {
  font-weight: 600;
  margin-bottom: 4px;
  font-size: 14px;
  color: #1a1a1a;
  letter-spacing: 0.2px;
}

.device-details {
  font-size: 11px;
  color: #666;
  line-height: 1.4;
  font-weight: 400;
  letter-spacing: 0.1px;
}

/* Redesigned action buttons */
.device-actions {
  display: flex;
  gap: 6px;
}

.device-actions button {
  background-color: #8B0000;
  border: none;
  border-radius: 4px;
  padding: 5px 10px;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.device-actions button:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 5px rgba(0,0,0,0.12);
}

.device-actions button.edit {
  color: #fff;
  background-color: #8b0000; /* Dark red for edit button */
  font-weight: 600;
  letter-spacing: 0.3px;
}

.device-actions button.remove {
  color: #fff;
  background-color: #8b0000; /* Dark red for remove button */
  font-weight: 600;
  letter-spacing: 0.3px;
}

/* Loading State */
.loading {
  padding: 20px;
  text-align: center;
  color: #777;
  font-size: 13px;
}

.loading i {
  animation: spin 1.2s linear infinite;
  color: #2e9a4f; /* Changed to green */
  font-size: 18px;
  margin-bottom: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Animation */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Scrollbar Styling */
.devices-list::-webkit-scrollbar {
  width: 4px;
}

.devices-list::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 8px;
}

.devices-list::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 8px;
}

.devices-list::-webkit-scrollbar-thumb:hover {
  background: #2e9a4f; /* Changed to green on hover */
}

/* Empty state message */
.empty-state {
  padding: 20px;
  text-align: center;
  color: #777;
}

.empty-state i {
  font-size: 24px;
  color: #2e9a4f; /* Green */
  margin-bottom: 8px;
}

/* Add new device button */
.add-device-btn {
  display: block;
  margin: 10px auto 15px;
  background-color: #2e9a4f; /* Green */
  color: white;
  border: none;
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.add-device-btn:hover {
  background-color: #1e7e34;
  transform: translateY(-1px);
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* For when you want to show the modal */
#deviceManagementModal.show {
  display: block;
}

/* Media query for smaller screens */
@media screen and (max-width: 480px) {
  #deviceManagementModal {
    width: calc(100% - 30px);
    right: 15px;
  }
  
  /* Ensure buttons remain usable on small screens */
  .device-actions button {
    padding: 6px 10px;
    font-size: 11px;
  }
}

/* Security Logs Modal CSS */

/* Modal Base Style */
#securityLogsModal {
  display: none;
  position: fixed;
  z-index: 1000;
  right: 15px;
  top: 15px;
  width: 320px; /* Compact width */
  box-shadow: 0 6px 16px rgba(0,0,0,0.18);
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.3s ease;
  animation: slideIn 0.4s ease-out;
}

/* Modal Content */
#securityLogsModal .modal-content {
  background-color: #fff;
  border-radius: 8px;
  padding: 0;
  position: relative;
  text-align: center; /* Center align all text content */
}

/* Modal Header */
#securityLogsModal .modal-content h2 {
  margin: 0;
  padding: 14px 16px;
  background: linear-gradient(135deg, #2e9a4f, #1e7e34); /* Green gradient background */
  color: white;
  font-size: 16px;
  font-weight: 500;
  border-radius: 8px 8px 0 0;
  display: flex;
  align-items: center;
  justify-content: center; /* Center the heading */
  gap: 8px;
}

#securityLogsModal .modal-content h2 i {
  font-size: 18px;
  color: #e8f5e9; /* Lighter green for icons */
}

/* Close Button */
#securityLogsModal .close-modal {
  position: absolute;
  right: 12px;
  top: 10px;
  color: white;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s;
  opacity: 0.8;
}

#securityLogsModal .close-modal:hover {
  transform: scale(1.1);
  opacity: 1;
}

/* Security Logs List Container */
#securityLogsList {
  max-height: 250px;
  overflow-y: auto;
  padding: 8px 0;
}

/* Individual Security Log Items */
.security-log-item {
  padding: 12px 16px;
  border-bottom: 1px solid #eaeaea;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: background-color 0.2s;
  text-align: left;
}

.security-log-item:hover {
  background-color: #f9fdf9; /* Very light green on hover */
}

.security-log-item:last-child {
  border-bottom: none;
}

.security-log-item i {
  color: #2e9a4f; /* Green */
  font-size: 15px;
}

.log-info {
  flex: 1;
  text-align: left;
  margin-left: 8px;
}

.log-title {
  font-weight: 600;
  margin-bottom: 4px;
  font-size: 14px;
  color: #1a1a1a;
  letter-spacing: 0.2px;
}

.log-details {
  font-size: 11px;
  color: #666;
  line-height: 1.4;
  font-weight: 400;
  letter-spacing: 0.1px;
}

.log-timestamp {
  font-size: 10px;
  color: #999;
  margin-top: 4px;
}

/* Loading State */
#securityLogsList .loading {
  padding: 20px;
  text-align: center;
  color: #777;
  font-size: 13px;
}

.loading i {
  animation: spin 1.2s linear infinite;
  color: #2e9a4f; /* Green */
  font-size: 18px;
  margin-bottom: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Animation */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Scrollbar Styling */
#securityLogsList::-webkit-scrollbar {
  width: 4px;
}

#securityLogsList::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 8px;
}

#securityLogsList::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 8px;
}

#securityLogsList::-webkit-scrollbar-thumb:hover {
  background: #2e9a4f; /* Green on hover */
}

/* Empty state message */
.empty-state {
  padding: 20px;
  text-align: center;
  color: #777;
}

.empty-state i {
  font-size: 24px;
  color: #2e9a4f; /* Green */
  margin-bottom: 8px;
}

/* For when you want to show the modal */
#securityLogsModal.show {
  display: block;
}

/* Media query for smaller screens */
@media screen and (max-width: 480px) {
  #securityLogsModal {
    width: calc(100% - 30px);
    right: 15px;
  }
}

.logout-btn {
  background-color: #4caf50;
  color: white;
  padding: 10px 16px;
  font-size: 14px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.2s ease-in-out;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-left: auto;
}

.logout-btn:hover {
  background-color: #388e3c;
}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1><i class="fas fa-shield-alt"></i> Admin Dashboard</h1>
<button onclick="switchTheme()" style="float: left; margin-top: -2px; margin-left: 5px; background: transparent; border: 1px solid white; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer;">
  Switch Theme
</button>
    </div>
  </header>

  <div class="container">
    <!-- Login Process -->
    <div id="authContainer" class="card login-card">
      <div class="security-progress">
        <div class="progress-step active" id="step1">
          <div class="step-indicator"></div>
          <div class="progress-step-label">Credentials</div>
        </div>
        <div class="progress-step" id="step2">
          <div class="step-indicator"></div>
          <div class="progress-step-label">Secret Key</div>
        </div>
        <div class="progress-step" id="step3">
          <div class="step-indicator"></div>
          <div class="progress-step-label">PIN</div>
        </div>
      </div>
      
      <!-- Step 1: Email and Password -->
      <div id="loginStep" class="auth-step active">
        <h2><i class="fas fa-lock"></i> Admin Login</h2>
        <div id="loginAlert" class="alert alert-error"></div>
        
        <div class="input-group">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="Admin Email">
        </div>
        
        <div class="input-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Password">
        </div>
        
        <button id="loginBtn" onclick="processLogin()">
          <i class="fas fa-arrow-right"></i> Continue
        </button>
      </div>
      
      <!-- Step 2: Secret Key -->
      <div id="secretKeyStep" class="auth-step">
        <h2><i class="fas fa-key"></i> Verify Secret Key</h2>
        <div id="secretKeyAlert" class="alert alert-error"></div>
        
        <div class="input-group">
          <label for="secretKey">Secret Key</label>
          <input type="password" id="secretKey" placeholder="Enter your secret key">
        </div>
        
        <div class="actions">
          <button class="secondary" onclick="backToLogin()">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button id="secretKeyBtn" onclick="verifySecretKey()">
            <i class="fas fa-arrow-right"></i> Continue
          </button>
        </div>
      </div>
      
      <!-- Step 3: PIN -->
      <div id="pinStep" class="auth-step">
        <h2><i class="fas fa-fingerprint"></i> Verify PIN</h2>
        <div id="pinAlert" class="alert alert-error"></div>
        
        <div class="input-group">
          <label for="adminPin">Admin PIN</label>
          <input type="password" id="adminPin" placeholder="Enter your admin PIN" maxlength="6">
        </div>
        
        <div class="actions">
          <button class="secondary" onclick="backToSecretKey()">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button id="pinBtn" onclick="verifyPin()">
            <i class="fas fa-sign-in-alt"></i> Login
          </button>
        </div>
      </div>
    </div>

    <!-- Admin Panel Content -->
    <div id="adminPanel" style="display:none;">
      <!-- Dashboard Stats -->
      <div class="dashboard-stats">
        <div class="stat-card">
          <h3>Total Users</h3>
          <div id="totalUsers" class="value">0</div>
        </div>
        <div class="stat-card">
          <h3>Active Users</h3>
          <div id="activeUsers" class="value">0</div>
        </div>
        <div class="stat-card">
          <h3>Total Airtime Balance</h3>
          <div id="totalBalance" class="value">0</div>
        </div>
        <div class="stat-card">
          <h3>Weekly Airtime Given</h3>
          <div id="weeklyAirtime" class="value">0</div>
        </div>
      </div>

      <!-- Tabs Navigation -->
      <div class="tabs">
        <div class="tab active" data-tab="users">
          <i class="fas fa-users"></i> User Management
        </div>
        <div class="tab" data-tab="settings">
          <i class="fas fa-cog"></i> Settings
        </div>
<div class="tab" data-tab="notifications">
  <i class="fas fa-bell"></i> Notifications
</div>
<div id="logoutTab" class="tab" style="margin-left: auto">
  <i class="fas fa-sign-out-alt"></i> Logout 
</div>
      </div>

      <!-- Users Tab Content -->
      <div id="usersTab" class="tab-content active">
        <div id="usersAlert" class="alert"></div>
        
        <div class="search-bar">
          <input type="text" id="searchUsers" placeholder="Search users by name, email or ID">
          <button id="searchBtn">
            <i class="fas fa-search"></i> Search
          </button>
          <button id="refreshBtn" class="secondary">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
        
        <div id="usersLoading" class="loading">
          <div class="spinner"></div>
        </div>
        
        <div id="users"></div>
      </div>

      <!-- Settings Tab Content -->
      <div id="settingsTab" class="tab-content">
        <div class="card">
          <h2>Dashboard Settings</h2>
          <p>Admin configuration options will appear here.</p>
        </div>
      </div>

<div id="notificationsTab" class="tab-content">
  <iframe src="notification%20admin.html" style="width: 100%; height: 1000px; border: none;"></iframe>
</div>
    </div>
  </div>


  <script>
    // Firebase Initialization -----
const firebaseConfig = {
  apiKey: "AIzaSyBw1uA-kNKOZEufWKZ9AMBxvRGHNGF1lkA",
  authDomain: "multi-games-a2561.firebaseapp.com",
  databaseURL: "https://multi-games-a2561-default-rtdb.firebaseio.com",
  projectId: "multi-games-a2561",
  storageBucket: "multi-games-a2561.appspot.com",
  messagingSenderId: "150551898066",
  appId: "1:150551898066:web:4e8fb185f2321ba4140a0b",
  measurementId: "G-PB8Y87E6XV"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// Global Variables
let currentUser = null;
let authStep = 1; // Track authentication step to prevent bypassing

// DOM Elements
const loginAlert = document.getElementById("loginAlert");
const secretKeyAlert = document.getElementById("secretKeyAlert");
const pinAlert = document.getElementById("pinAlert");
const usersAlert = document.getElementById("usersAlert");
const usersLoading = document.getElementById("usersLoading");

// Browser Fingerprinting Functions
async function getBrowserFingerprint() {
  // Get browser details
  const browserData = {
    userAgent: navigator.userAgent,
    language: navigator.language,
    platform: navigator.platform,
    screenWidth: window.screen.width,
    screenHeight: window.screen.height,
    colorDepth: window.screen.colorDepth,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    timestamp: Date.now()
  };
  
  // Get IP address through an external service (you might need to set up your own endpoint)
  try {
    const ipResponse = await fetch('https://api.ipify.org?format=json');
    const ipData = await ipResponse.json();
    browserData.ipAddress = ipData.ip;
  } catch (error) {
    console.error("Could not fetch IP address:", error);
    browserData.ipAddress = "unknown";
  }
  
  // Create a unique fingerprint hash
  const fingerprintString = JSON.stringify(browserData);
  let fingerprint = "";
  
  // Simple hash function (in production, use a more robust hashing algorithm)
  for (let i = 0; i < fingerprintString.length; i++) {
    fingerprint += fingerprintString.charCodeAt(i).toString(16);
  }
  
  return {
    fingerprint: fingerprint.substring(0, 32), // Use first 32 chars as fingerprint
    details: browserData
  };
}

// Verify Browser Fingerprint
async function verifyBrowserFingerprint(uid) {
  try {
    // Get current browser fingerprint
    const currentBrowser = await getBrowserFingerprint();
    
    // Check if this is the first login (no stored fingerprints yet)
    const fingerprints = await db.ref(`adminUsers/${uid}/devices`).get();
    
    if (!fingerprints.exists()) {
      // First login - store the fingerprint
      await db.ref(`adminUsers/${uid}/devices`).push({
        fingerprint: currentBrowser.fingerprint,
        details: currentBrowser.details,
        firstUsed: Date.now(),
        lastUsed: Date.now()
      });
      return { verified: true, firstLogin: true };
    } else {
      // Check if current browser matches any stored fingerprints
      let matched = false;
      
      fingerprints.forEach(childSnap => {
        const device = childSnap.val();
        if (device.fingerprint === currentBrowser.fingerprint) {
          matched = true;
          // Update last used timestamp
          db.ref(`adminUsers/${uid}/devices/${childSnap.key}`).update({
            lastUsed: Date.now()
          });
        }
      });
      
      if (!matched) {
        // Log the suspicious login attempt
        await db.ref("admin/securityAlerts").push({
          adminId: uid,
          alertType: "unknown_device",
          browserDetails: currentBrowser.details,
          timestamp: Date.now()
        });
        
        return { verified: false, reason: "unrecognized_browser" };
      }
      
      return { verified: true, firstLogin: false };
    }
  } catch (error) {
    console.error("Error verifying browser fingerprint:", error);
    return { verified: false, reason: "verification_error", error: error.message };
  }
}

// Error Handling Function
function showAlert(element, message, type = "error") {
  element.textContent = message;
  element.className = type === "error" ? "alert alert-error" : "alert alert-success";
  element.style.display = "block";
  
  // Auto-hide after 5 seconds
  setTimeout(() => {
    element.style.display = "none";
  }, 5000);
}

// Multi-step Authentication Functions
async function processLogin() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const loginBtn = document.getElementById("loginBtn");
  
  // Reset authentication step
  authStep = 1;
  
  // Validation
  if (!email || !password) {
    showAlert(loginAlert, "Please enter both email and password");
    return;
  }
  
  // Change button state
  loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
  loginBtn.disabled = true;

  try {
    // Attempt login
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    
    // Check if this user is an admin first
    const adminSnapshot = await db.ref(`adminUsers/${currentUser.uid}`).get();
    
    if (!adminSnapshot.exists()) {
      throw new Error("Not authorized as admin");
    }
    
    // Verify browser fingerprint
    const fingerprintCheck = await verifyBrowserFingerprint(currentUser.uid);
    
    if (!fingerprintCheck.verified) {
      if (fingerprintCheck.reason === "unrecognized_browser") {
        throw new Error("Security alert: Unrecognized browser or device detected");
      } else {
        throw new Error("Browser verification failed: " + fingerprintCheck.reason);
      }
    }
    
    // Proceed to secret key step
    authStep = 2;
    document.getElementById("step1").classList.remove("active");
    document.getElementById("step1").classList.add("completed");
    document.getElementById("step2").classList.add("active");
    document.getElementById("loginStep").classList.remove("active");
    document.getElementById("secretKeyStep").classList.add("active");
    
  } catch (error) {
    let errorMessage = "Login failed";
    
    switch(error.code) {
      case 'auth/user-not-found':
        errorMessage = "No user found with this email address";
        break;
      case 'auth/wrong-password':
        errorMessage = "Incorrect password";
        break;
      case 'auth/invalid-email':
        errorMessage = "Invalid email format";
        break;
      case 'auth/user-disabled':
        errorMessage = "This account has been disabled";
        break;
      case 'auth/too-many-requests':
        errorMessage = "Too many failed login attempts. Please try again later";
        break;
      default:
        errorMessage = error.message;
    }
    
    showAlert(loginAlert, errorMessage);
    auth.signOut();
  } finally {
    loginBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Continue';
    loginBtn.disabled = false;
  }
}

async function verifySecretKey() {
  const secretKey = document.getElementById("secretKey").value;
  const secretKeyBtn = document.getElementById("secretKeyBtn");
  
  // Verify we're on the correct step
  if (authStep !== 2) {
    showAlert(secretKeyAlert, "Authentication step error. Please start over.");
    backToLogin();
    return;
  }
  
  if (!secretKey) {
    showAlert(secretKeyAlert, "Please enter your secret key");
    return;
  }
  
  secretKeyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
  secretKeyBtn.disabled = true;
  
  try {
    // Check if secret key matches
    const snapshot = await db.ref("admin/secretKey").get();
    
    if (!snapshot.exists() || snapshot.val() !== secretKey) {
      // Log failed attempt
      await db.ref("admin/securityAlerts").push({
        adminId: currentUser.uid,
        email: currentUser.email,
        alertType: "invalid_secret_key",
        timestamp: Date.now()
      });
      
      throw new Error("Invalid secret key");
    }
    
    // Move to PIN step
    authStep = 3;
    document.getElementById("step2").classList.remove("active");
    document.getElementById("step2").classList.add("completed");
    document.getElementById("step3").classList.add("active");
    document.getElementById("secretKeyStep").classList.remove("active");
    document.getElementById("pinStep").classList.add("active");
    
  } catch (error) {
    showAlert(secretKeyAlert, error.message);
    auth.signOut();
  } finally {
    secretKeyBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Continue';
    secretKeyBtn.disabled = false;
  }
}

async function verifyPin() {
  const pin = document.getElementById("adminPin").value;
  const pinBtn = document.getElementById("pinBtn");
  
  // Verify we're on the correct step
  if (authStep !== 3) {
    showAlert(pinAlert, "Authentication step error. Please start over.");
    backToLogin();
    return;
  }
  
  if (!pin) {
    showAlert(pinAlert, "Please enter your admin PIN");
    return;
  }
  
  pinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
  pinBtn.disabled = true;
  
  try {
    // Verify PIN and check admin status
    const snapshot = await db.ref(`adminUsers/${currentUser.uid}`).get();
    
    if (!snapshot.exists() || snapshot.val().pin !== pin) {
      // Log failed attempt
      await db.ref("admin/securityAlerts").push({
        adminId: currentUser.uid,
        email: currentUser.email,
        alertType: "invalid_pin",
        timestamp: Date.now()
      });
      
      throw new Error("Invaild PIN ");
    }
    
    // Login successful
    document.getElementById("authContainer").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
    loadDashboardData();
    
    // Log admin access with browser details
    const browserInfo = await getBrowserFingerprint();
    
    await db.ref("admin/logs").push({
      adminId: currentUser.uid,
      action: "admin_login",
      email: currentUser.email,
      timestamp: Date.now(),
      browserDetails: browserInfo.details
    });
    
    // Reset auth step
    authStep = 0;
    
  } catch (error) {
    showAlert(pinAlert, error.message);
    auth.signOut();
  } finally {
    pinBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
    pinBtn.disabled = false;
  }
}

function backToLogin() {
  document.getElementById("step2").classList.remove("active");
  document.getElementById("step1").classList.remove("completed");
  document.getElementById("step1").classList.add("active");
  document.getElementById("secretKeyStep").classList.remove("active");
  document.getElementById("loginStep").classList.add("active");
  authStep = 1;
  auth.signOut();
}

function backToSecretKey() {
  document.getElementById("step3").classList.remove("active");
  document.getElementById("step2").classList.remove("completed");
  document.getElementById("step2").classList.add("active");
  document.getElementById("pinStep").classList.remove("active");
  document.getElementById("secretKeyStep").classList.add("active");
  authStep = 2;
}

// Dashboard Functions
async function loadDashboardData() {
  loadUsers();
  loadStats();
}

// Load Statistics
async function loadStats() {
  try {
    const snapshot = await db.ref("users").get();
    
    let totalUsers = 0;
    let activeUsers = 0;
    let totalBalance = 0;
    let weeklyAirtimeTotal = 0;
    
    snapshot.forEach(childSnap => {
      const user = childSnap.val();
      totalUsers++;
      
      if (user.status === "active" || !user.status) {
        activeUsers++;
      }
      
      totalBalance += parseFloat(user.airtimeBalance || 0);
      weeklyAirtimeTotal += parseFloat(user.weeklyAirtime || 0);
    });
    
    document.getElementById("totalUsers").textContent = totalUsers;
    document.getElementById("activeUsers").textContent = activeUsers;
    document.getElementById("totalBalance").textContent = totalBalance.toFixed(2);
    document.getElementById("weeklyAirtime").textContent = weeklyAirtimeTotal.toFixed(2);
  } catch (error) {
    console.error("Error loading stats:", error);
  }
}

// Helper function to format timestamps
function formatDate(timestamp) {
  if (!timestamp) return "N/A";
  
  const date = new Date(timestamp);
  return date.toLocaleDateString() + " " + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Load Users
async function loadUsers() {
  const usersDiv = document.getElementById("users");
  usersDiv.innerHTML = "";
  usersLoading.style.display = "flex";
  
  try {
    const snapshot = await db.ref("users").get();
    
    if (!snapshot.exists()) {
      usersDiv.innerHTML = '<div class="card">No users found in the database.</div>';
      usersLoading.style.display = "none";
      return;
    }
    
    const searchTerm = document.getElementById("searchUsers").value.toLowerCase();
    let hasUsers = false;
    
    snapshot.forEach(childSnap => {
      const uid = childSnap.key;
      const user = childSnap.val();
      
      // Filter by search term if present
      if (searchTerm && 
          !(user.name?.toLowerCase().includes(searchTerm) || 
            user.email?.toLowerCase().includes(searchTerm) ||
            uid.toLowerCase().includes(searchTerm))) {
        return;
      }
      
      hasUsers = true;
      const userCard = document.createElement("div");
      userCard.className = "card user-card";
      
      // Determine user status
      const userStatus = user.status || "active";
      const statusBadge = `<span class="status-badge badge-${userStatus}">${userStatus}</span>`;
      
      // Process the airtime history to show the last 3 entries
      let airtimeHistoryHTML = '<div class="airtime-history"><h4>Last 3 Airtime Transactions</h4>';
      
      if (user.airtimeHistory) {
        const historyEntries = Object.entries(user.airtimeHistory)
          .sort((a, b) => b[1].timestamp - a[1].timestamp)
          .slice(0, 3);
        
        if (historyEntries.length > 0) {
          historyEntries.forEach(([key, entry]) => {
            const date = formatDate(entry.timestamp);
            const amountClass = parseFloat(entry.amount) >= 0 ? 'history-positive' : 'history-negative';
            
            airtimeHistoryHTML += `
              <div class="history-item">
                <span class="history-amount ${amountClass}">${parseFloat(entry.amount).toFixed(2)}</span>
                <span class="history-date">${date}</span>
              </div>
            `;
          });
        } else {
          airtimeHistoryHTML += '<div class="history-item">No transaction history available</div>';
        }
      } else {
        airtimeHistoryHTML += '<div class="history-item">No transaction history available</div>';
      }
      
      airtimeHistoryHTML += '</div>';
      
      userCard.innerHTML = `
        <div class="user-actions">
          <button class="secondary" onclick="viewUserDetails('${uid}')">
            <i class="fas fa-eye"></i> Details
          </button>
        </div>
        
        <h3>
          <i class="fas fa-user"></i>
          ${user.name || "Unnamed User"}
          <span class="user-id">(ID: ${uid.substring(0, 8)}...)</span>
          ${statusBadge}
        </h3>
        
        <div class="user-info">
          <div class="user-field">
            <div class="field-name">Email:</div>
            <div class="field-value">${user.email || "N/A"}</div>
          </div>
          
          <div class="user-field">
            <div class="field-name">Phone:</div>
            <div class="field-value">${user.phone || "N/A"}</div>
          </div>
          
          <div class="user-field">
            <div class="field-name">Referrals:</div>
            <div class="field-value">${user.referrals || "0"}</div>
          </div>
          
          <div class="user-field">
            <div class="field-name">Date Joined:</div>
            <div class="field-value">${user.dateJoined || "N/A"}</div>
          </div>
          
          <div class="user-field">
            <div class="field-name">Referral Code:</div>
            <div class="field-value">${user.referralCode || "N/A"}</div>
          </div>
          
          <div class="user-field">
            <div class="field-name">Last Login:</div>
            <div class="field-value">${formatDate(user.lastLogin) || "Never"}</div>
          </div>
        </div>
        
        <div class="user-field edit-field">
          <div class="field-name">Airtime Balance:</div>
          <input id="bal-${uid}" type="number" step="0.01" value="${user.airtimeBalance || 0}">
          <button onclick="updateBalance('${uid}')">
            <i class="fas fa-save"></i> Update
          </button>
        </div>
        
        <div class="user-field edit-field">
          <div class="field-name">User Status:</div>
          <select id="status-${uid}">
            <option value="active" ${userStatus === "active" ? "selected" : ""}>Active</option>
            <option value="suspended" ${userStatus === "suspended" ? "selected" : ""}>Suspended</option>
            <option value="blocked" ${userStatus === "blocked" ? "selected" : ""}>Blocked</option>
          </select>
          <button onclick="updateStatus('${uid}')">
            <i class="fas fa-save"></i> Update
          </button>
        </div>
        
        ${airtimeHistoryHTML}
      `;
      
      usersDiv.appendChild(userCard);
    });
    
    if (!hasUsers) {
      usersDiv.innerHTML = '<div class="card">No users match your search criteria.</div>';
    }
  } catch (error) {
    usersDiv.innerHTML = `<div class="card">Error loading users: ${error.message}</div>`;
    console.error("Error loading users:", error);
  } finally {
    usersLoading.style.display = "none";
  }
}

// User Management Functions
async function updateBalance(uid) {
  const newBalance = document.getElementById(`bal-${uid}`).value;
  
  if (isNaN(newBalance) || newBalance === "") {
    showAlert(usersAlert, "Please enter a valid balance amount");
    return;
  }
  
  const floatBalance = parseFloat(newBalance);
  
  try {
    // Get the current balance to calculate the difference
    const snapshot = await db.ref(`users/${uid}/airtimeBalance`).get();
    const oldBalance = snapshot.exists() ? parseFloat(snapshot.val()) : 0;
    const changeAmount = floatBalance - oldBalance;
    
    // Update the balance
    await db.ref(`users/${uid}`).update({
      airtimeBalance: floatBalance
    });
    
    // Add to airtime history
    const historyKey = db.ref(`users/${uid}/airtimeHistory`).push().key;
    
    await db.ref(`users/${uid}/airtimeHistory/${historyKey}`).set({
      amount: changeAmount,
      timestamp: Date.now(),
      note: "Admin balance adjustment",
      adminId: currentUser.uid
    });
    
    showAlert(usersAlert, `Balance updated successfully for user ${uid}`, "success");
    loadUsers();
    loadStats();
    
  } catch (error) {
    showAlert(usersAlert, `Error updating balance: ${error.message}`);
  }
}

async function updateStatus(uid) {
  const newStatus = document.getElementById(`status-${uid}`).value;
  
  try {
    await db.ref(`users/${uid}`).update({
      status: newStatus
    });
    
    showAlert(usersAlert, `Status updated successfully for user ${uid}`, "success");
    loadUsers();
    loadStats();
    
    // Log the status change
    await db.ref("admin/logs").push({
      adminId: currentUser.uid,
      action: "status_update",
      userId: uid,
      newStatus: newStatus,
      timestamp: Date.now()
    });
    
  } catch (error) {
    showAlert(usersAlert, `Error updating status: ${error.message}`);
  }
}

function viewUserDetails(uid) {
  // Open a modal or redirect to a detailed user view
  alert(`Detailed view for user ${uid} will be implemented here.`);
  
  // For a more sophisticated implementation, you might want to:
  // 1. Create a modal component
    // 2. Fetch full user data including all history
  // 3. Display it in the modal
}

// Tab Navigation
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', function() {
    const tabName = this.getAttribute('data-tab');
    
    // Skip if it's the logout tab
    if (tabName === null) return;
    
    // Update active tab
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(`${tabName}Tab`).classList.add('active');
  });
});

// Search functionality
document.getElementById('searchBtn').addEventListener('click', () => {
  loadUsers();
});

document.getElementById('searchUsers').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    loadUsers();
  }
});

// Refresh button
document.getElementById('refreshBtn').addEventListener('click', () => {
  document.getElementById('searchUsers').value = '';
  loadUsers();
  loadStats();
});

// Logout functionality
document.getElementById('logoutTab').addEventListener('click', async () => {
  try {
    // Log the logout action
    if (currentUser) {
      const browserInfo = await getBrowserFingerprint();
      
      await db.ref("admin/logs").push({
        adminId: currentUser.uid,
        action: "admin_logout",
        email: currentUser.email,
        timestamp: Date.now(),
        browserDetails: browserInfo.details
      });
    }
    
    await auth.signOut();
    
    // Reset the UI
    document.getElementById("adminPanel").style.display = "none";
    document.getElementById("authContainer").style.display = "block";
    document.getElementById("step3").classList.remove("active");
    document.getElementById("step3").classList.remove("completed");
    document.getElementById("step2").classList.remove("active");
    document.getElementById("step2").classList.remove("completed");
    document.getElementById("step1").classList.add("active");
    document.getElementById("step1").classList.remove("completed");
    document.getElementById("pinStep").classList.remove("active");
    document.getElementById("secretKeyStep").classList.remove("active");
    document.getElementById("loginStep").classList.add("active");
    
    // Clear form fields
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";
    document.getElementById("secretKey").value = "";
    document.getElementById("adminPin").value = "";
    
    currentUser = null;
    authStep = 1;
    
  } catch (error) {
    console.error("Error signing out:", error);
  }
});

// Authentication state observer
auth.onAuthStateChanged((user) => {
  if (user) {
    // User is signed in - check if they're already at the dashboard
    // This prevents resetting the auth flow if they reload the page while logged in
    if (document.getElementById("adminPanel").style.display === "block") {
      currentUser = user;
    }
  } else {
    // User is signed out
    currentUser = null;
    authStep = 1;
    
    // If they're not on the login page, redirect them there
    if (document.getElementById("adminPanel").style.display === "block") {
      document.getElementById("adminPanel").style.display = "none";
      document.getElementById("authContainer").style.display = "block";
      document.getElementById("loginStep").classList.add("active");
    }
  }
});

// Settings Tab Content
window.onload = function () {

document.getElementById('settingsTab').innerHTML = `
  <div class="card">
    <h2><i class="fas fa-cog"></i> Dashboard Settings</h2>

<div id="settingsAlert" class="alert" style="display: none;"></div>
    
    <div class="settings-section">
      <h3>Security Settings</h3>
      
      <div class="input-group">
        <label for="adminSecretKey">Admin Secret Key</label>
        <input type="password" id="adminSecretKey" placeholder="Enter new secret key">
        <button id="updateSecretKeyBtn" onclick="updateSecretKey()">
          <i class="fas fa-key"></i> Update Secret Key
        </button>
      </div>
      
      <div class="input-group">
        <label for="adminPinUpdate">Admin PIN</label>
        <input type="password" id="adminPinUpdate" placeholder="Enter new PIN" maxlength="6">
        <button id="updatePinBtn" onclick="updatePin()">
          <i class="fas fa-lock"></i> Update PIN
        </button>
      </div>
      
      <div class="input-group">
        <label for="manageDevices">Device Management</label>
        <button id="manageDevicesBtn" onclick="showDeviceManagement()">
          <i class="fas fa-laptop"></i> Manage Trusted Devices
        </button>
      </div>
    </div>
    
    <div class="settings-section">
      <h3>System Settings</h3>
      
      <div class="input-group">
        <label for="referralBonus">Referral Bonus Amount</label>
        <input type="number" id="referralBonus" step="0.01" placeholder="Enter bonus amount">
        <button id="updateBonusBtn" onclick="updateReferralBonus()">
          <i class="fas fa-save"></i> Update
        </button>
      </div>
      
      <div class="input-group">
        <label for="systemStatus">System Status</label>
        <select id="systemStatus">
          <option value="online">Online</option>
          <option value="maintenance">Maintenance Mode</option>
          <option value="readonly">Read-Only Mode</option>
        </select>
        <button id="updateSystemStatusBtn" onclick="updateSystemStatus()">
          <i class="fas fa-save"></i> Update
        </button>
      </div>
    </div>

<div class="settings-section">
  <h3>Security Logs</h3>
  <button onclick="viewSecurityLogs()">
    <i class="fas fa-shield-alt"></i> View Security Alerts
  </button>
</div>

  <div class="settings-section">
      <h3> </h3>
            <button id="logoutBtnSettings" class="logout-btn">
           <i class="fas fa-sign-out-alt"></i> Logout
        </button>
        </div>
      </div>

  
  <!-- Device Management Modal -->
  <div id="deviceManagementModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-modal" onclick="closeDeviceModal()">&times;</span>
      <h2><i class="fas fa-laptop"></i> Trusted Devices</h2>
      <div id="devicesList" class="devices-list">
        <!-- Devices will be loaded here -->
        <div class="loading">Loading devices...</div>
      </div>
    </div>
  </div>
  
  <!-- Security Logs Modal -->
  <div id="securityLogsModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-modal" onclick="closeSecurityLogsModal()">&times;</span>
      <h2><i class="fas fa-shield-alt"></i> Security Alerts</h2>
      <div id="securityLogsList" class="security-logs-list">
        <!-- Security logs will be loaded here -->
        <div class="loading">Loading security logs...</div>
      </div>
    </div>
  </div>
`;

document.getElementById("logoutBtnSettings").addEventListener("click", () => {
  document.getElementById("logoutTab").click();
});
};

// Settings Functions
async function updateSecretKey() {
  const newSecretKey = document.getElementById("adminSecretKey").value;
  
  if (!newSecretKey || newSecretKey.length < 8) {
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      "Secret key must be at least 8 characters");
    return;
  }
  
  try {
    await db.ref("admin/secretKey").set(newSecretKey);
    
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      "Secret key updated successfully", "success");
    document.getElementById("adminSecretKey").value = "";
    
    // Log the action
    await db.ref("admin/logs").push({
      adminId: currentUser.uid,
      action: "update_secret_key",
      timestamp: Date.now()
    });
    
  } catch (error) {
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      `Error updating secret key: ${error.message}`);
  }
}

async function updatePin() {
  const newPin = document.getElementById("adminPinUpdate").value;
  
  if (!newPin || newPin.length !== 6 || isNaN(newPin)) {
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      "PIN must be exactly 6 digits");
    return;
  }
  
  try {
    await db.ref(`adminUsers/${currentUser.uid}`).update({
      pin: newPin
    });
    
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      "PIN updated successfully", "success");
    document.getElementById("adminPinUpdate").value = "";
    
    // Log the action
    await db.ref("admin/logs").push({
      adminId: currentUser.uid,
      action: "update_pin",
      timestamp: Date.now()
    });
    
  } catch (error) {
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      `Error updating PIN: ${error.message}`);
  }
}

async function updateReferralBonus() {
  const newBonus = document.getElementById("referralBonus").value;
  
  if (isNaN(newBonus) || newBonus === "") {
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      "Please enter a valid bonus amount");
    return;
  }
  
  try {
    await db.ref("admin/settings/referralBonus").set(parseFloat(newBonus));
    
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      "Referral bonus updated successfully", "success");
    
    // Log the action
    await db.ref("admin/logs").push({
      adminId: currentUser.uid,
      action: "update_referral_bonus",
      newBonus: parseFloat(newBonus),
      timestamp: Date.now()
    });
    
  } catch (error) {
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      `Error updating referral bonus: ${error.message}`);
  }
}

async function updateSystemStatus() {
  const newStatus = document.getElementById("systemStatus").value;
  
  try {
    await db.ref("admin/settings/systemStatus").set(newStatus);
    
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      "System status updated successfully", "success");
    
    // Log the action
    await db.ref("admin/logs").push({
      adminId: currentUser.uid,
      action: "update_system_status",
      newStatus: newStatus,
      timestamp: Date.now()
    });
    
  } catch (error) {
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      `Error updating system status: ${error.message}`);
  }
}

// Device Management Modal Functions
async function showDeviceManagement() {
  const modal = document.getElementById("deviceManagementModal");
  const devicesList = document.getElementById("devicesList");
  
  modal.style.display = "block";
  devicesList.innerHTML = '<div class="loading">Loading devices...</div>';
  
  try {
    const snapshot = await db.ref(`adminUsers/${currentUser.uid}/devices`).get();
    
    if (!snapshot.exists()) {
      devicesList.innerHTML = '<div class="no-data">No trusted devices found.</div>';
      return;
    }
    
    devicesList.innerHTML = '';
    
    snapshot.forEach(childSnap => {
      const deviceId = childSnap.key;
      const device = childSnap.val();
      
      const deviceCard = document.createElement("div");
      deviceCard.className = "device-card";
      
      // Format dates
      const firstUsed = formatDate(device.firstUsed);
      const lastUsed = formatDate(device.lastUsed);
      
      // Check if this is the current device
      const currentBrowserFingerprint = getBrowserFingerprint().then(fp => {
        if (fp.fingerprint === device.fingerprint) {
          deviceCard.classList.add("current-device");
        }
      });
      
      deviceCard.innerHTML = `
        <div class="device-info">
          <h4>Device ${deviceId.substring(0, 8)}</h4>
          <div class="device-field">
            <strong>First Used:</strong> ${firstUsed}
          </div>
          <div class="device-field">
            <strong>Last Used:</strong> ${lastUsed}
          </div>
          <div class="device-field">
            <strong>Browser:</strong> ${device.details.userAgent.split(' ').slice(0, 3).join(' ')}
          </div>
          <div class="device-field">
            <strong>Platform:</strong> ${device.details.platform}
          </div>
          <div class="device-field">
            <strong>IP Address:</strong> ${device.details.ipAddress || 'Unknown'}
          </div>
        </div>
        <div class="device-actions">
          <button class="danger" onclick="removeDevice('${deviceId}')">
            <i class="fas fa-trash"></i> Remove
          </button>
        </div>
      `;
      
      devicesList.appendChild(deviceCard);
    });
    
  } catch (error) {
    devicesList.innerHTML = `<div class="error">Error loading devices: ${error.message}</div>`;
  }
}

function closeDeviceModal() {
  document.getElementById("deviceManagementModal").style.display = "none";
}

async function removeDevice(deviceId) {
  try {
    // Check if this is the current device
    const currentBrowser = await getBrowserFingerprint();
    const deviceSnapshot = await db.ref(`adminUsers/${currentUser.uid}/devices/${deviceId}`).get();
    
    if (deviceSnapshot.exists() && deviceSnapshot.val().fingerprint === currentBrowser.fingerprint) {
      if (!confirm("This is your current device. Are you sure you want to remove it? You will be logged out immediately.")) {
        return;
      }
    }
    
    await db.ref(`adminUsers/${currentUser.uid}/devices/${deviceId}`).remove();
    
    // Log the action
    await db.ref("admin/logs").push({
      adminId: currentUser.uid,
      action: "remove_device",
      deviceId: deviceId,
      timestamp: Date.now()
    });
    
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      "Device removed successfully", "success");
    
    // Refresh the devices list
    showDeviceManagement();
    
    // If current device was removed, log out
    if (deviceSnapshot.exists() && deviceSnapshot.val().fingerprint === currentBrowser.fingerprint) {
      setTimeout(() => {
        auth.signOut();
      }, 2000);
    }
    
  } catch (error) {
    showAlert(document.querySelector("#settingsTab .alert") || usersAlert, 
      `Error removing device: ${error.message}`);
  }
}

// Security Logs Functions
async function viewSecurityLogs() {
  const modal = document.getElementById("securityLogsModal");
  const logsList = document.getElementById("securityLogsList");
  
  modal.style.display = "block";
  logsList.innerHTML = '<div class="loading">Loading security logs...</div>';
  
  try {
    const snapshot = await db.ref("admin/securityAlerts").orderByChild("timestamp").limitToLast(50).get();
    
    if (!snapshot.exists()) {
      logsList.innerHTML = '<div class="no-data">No security alerts found.</div>';
      return;
    }
    
    logsList.innerHTML = '<div class="security-logs-header">Showing the 50 most recent security alerts</div>';
    
    // Convert to array for sorting
    const alerts = [];
    snapshot.forEach(childSnap => {
      alerts.push({
        id: childSnap.key,
        ...childSnap.val()
      });
    });
    
    // Sort by timestamp descending (newest first)
    alerts.sort((a, b) => b.timestamp - a.timestamp);
    
    alerts.forEach(alert => {
      const alertCard = document.createElement("div");
      alertCard.className = "security-alert";
      
      // Determine alert type icon and class
      let alertIcon = "fas fa-exclamation-triangle";
      let alertClass = "medium-alert";
      
      switch(alert.alertType) {
        case "invalid_pin":
        case "invalid_secret_key":
          alertIcon = "fas fa-shield-alt";
          alertClass = "high-alert";
          break;
        case "unknown_device":
          alertIcon = "fas fa-laptop";
          alertClass = "high-alert";
          break;
        case "verification_error":
          alertIcon = "fas fa-bug";
          alertClass = "medium-alert";
          break;
        default:
          alertIcon = "fas fa-exclamation-circle";
          alertClass = "low-alert";
      }
      
      alertCard.classList.add(alertClass);
      
      const formattedTime = formatDate(alert.timestamp);
      
      alertCard.innerHTML = `
        <div class="alert-header">
          <i class="${alertIcon}"></i>
          <span>${alert.alertType.replace(/_/g, ' ').toUpperCase()}</span>
          <span class="alert-time">${formattedTime}</span>
        </div>
        <div class="alert-details">
          <div class="alert-field">
            <strong>Admin ID:</strong> ${alert.adminId || 'N/A'}
          </div>
          <div class="alert-field">
            <strong>Admin Email:</strong> ${alert.email || 'N/A'}
          </div>
          ${alert.browserDetails ? `
            <div class="alert-field">
              <strong>Device Info:</strong> ${alert.browserDetails.platform} - ${alert.browserDetails.userAgent.split(' ').slice(0, 3).join(' ')}
            </div>
            <div class="alert-field">
              <strong>IP Address:</strong> ${alert.browserDetails.ipAddress || 'Unknown'}
            </div>
          ` : ''}
          ${alert.error ? `
            <div class="alert-field error-message">
              <strong>Error:</strong> ${alert.error}
            </div>
          ` : ''}
        </div>
        <div class="alert-actions">
          <button class="dismiss-alert" onclick="dismissAlert('${alert.id}')">
            <i class="fas fa-check"></i> Dismiss
          </button>
        </div>
      `;
      
      logsList.appendChild(alertCard);
    });
    
  } catch (error) {
    logsList.innerHTML = `<div class="error">Error loading security logs: ${error.message}</div>`;
  }
}

function closeSecurityLogsModal() {
  document.getElementById("securityLogsModal").style.display = "none";
}

async function dismissAlert(alertId) {
  try {
    await db.ref(`admin/securityAlerts/${alertId}`).update({
      dismissed: true,
      dismissedBy: currentUser.uid,
      dismissedAt: Date.now()
    });
    
    // Refresh the security logs
    viewSecurityLogs();
    
  } catch (error) {
    showAlert(document.querySelector("#securityLogsModal .alert") || usersAlert, 
      `Error dismissing alert: ${error.message}`);
  }
}

// Analytics Tab Content
document.getElementById('analyticsTab').innerHTML = `
  <div class="analytics-container">
    <div class="card">
      <h2><i class="fas fa-chart-line"></i> Analytics Dashboard</h2>
      
      <div class="date-filter">
        <label for="dateRange">Time Period:</label>
        <select id="dateRange" onchange="updateAnalytics()">
          <option value="7">Last 7 Days</option>
          <option value="30" selected>Last 30 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="180">Last 6 Months</option>
          <option value="365">Last Year</option>
        </select>
        <button onclick="updateAnalytics()">
          <i class="fas fa-sync"></i> Refresh
        </button>
      </div>
      
      <div class="charts-container">
        <div class="chart-card">
          <h3>User Growth</h3>
          <div id="userGrowthChart" class="chart">
            <div class="loading">Loading chart...</div>
          </div>
        </div>
        
        <div class="chart-card">
          <h3>Airtime Transactions</h3>
          <div id="airtimeChart" class="chart">
            <div class="loading">Loading chart...</div>
          </div>
        </div>
      </div>
      
      <div class="charts-container">
        <div class="chart-card">
          <h3>Active Users</h3>
          <div id="activeUsersChart" class="chart">
            <div class="loading">Loading chart...</div>
          </div>
        </div>
        
        <div class="chart-card">
          <h3>Referral Performance</h3>
          <div id="referralChart" class="chart">
            <div class="loading">Loading chart...</div>
          </div>
        </div>
      </div>
      
      <div class="analytics-summary">
        <h3>Summary Stats</h3>
        <div id="analyticsStats" class="stats-container">
          <div class="stat-card">
            <i class="fas fa-user-plus"></i>
            <div class="stat-value" id="newUsersCount">-</div>
            <div class="stat-label">New Users</div>
          </div>
          
          <div class="stat-card">
            <i class="fas fa-hand-holding-usd"></i>
            <div class="stat-value" id="airtimeVolume">-</div>
            <div class="stat-label">Airtime Volume</div>
          </div>
          
          <div class="stat-card">
            <i class="fas fa-user-check"></i>
            <div class="stat-value" id="activeUsersPct">-</div>
            <div class="stat-label">Active Users %</div>
          </div>
          
          <div class="stat-card">
            <i class="fas fa-users"></i>
            <div class="stat-value" id="referralCount">-</div>
            <div class="stat-label">Referrals</div>
          </div>
        </div>
      </div>
    </div>
  </div>
`;

// Analytics Functions
async function updateAnalytics() {
  const days = document.getElementById("dateRange").value;
  const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000);
  
  try {
    // Get users data
    const usersSnapshot = await db.ref("users").get();
    const users = [];
    
    usersSnapshot.forEach(childSnap => {
      users.push({
        id: childSnap.key,
        ...childSnap.val()
      });
    });
    
    // Process analytics data
    const userGrowth = analyzeUserGrowth(users, cutoff);
    const airtimeTransactions = analyzeAirtimeTransactions(users, cutoff);
    const activeUsers = analyzeActiveUsers(users, cutoff);
    const referrals = analyzeReferrals(users, cutoff);
    
    // Update summary stats
    updateSummaryStats(users, cutoff);
    
    // Render charts (you would need a charting library like Chart.js in a real implementation)
    // Here we'll just simulate the charts with placeholder data
    document.getElementById("userGrowthChart").innerHTML = `
      <div class="placeholder-chart">
        <div class="chart-placeholder-text">User Growth Chart would be here</div>
        <div class="chart-data-placeholder">
          <div>New Users: ${userGrowth.totalNewUsers}</div>
          <div>Growth Rate: ${userGrowth.growthRate}%</div>
        </div>
      </div>
    `;
    
    document.getElementById("airtimeChart").innerHTML = `
      <div class="placeholder-chart">
        <div class="chart-placeholder-text">Airtime Transactions Chart would be here</div>
        <div class="chart-data-placeholder">
          <div>Total Volume: ${airtimeTransactions.totalVolume.toFixed(2)}</div>
          <div>Transaction Count: ${airtimeTransactions.count}</div>
        </div>
      </div>
    `;
    
    document.getElementById("activeUsersChart").innerHTML = `
      <div class="placeholder-chart">
        <div class="chart-placeholder-text">Active Users Chart would be here</div>
        <div class="chart-data-placeholder">
          <div>Active Users: ${activeUsers.count}</div>
          <div>Active Rate: ${activeUsers.rate.toFixed(2)}%</div>
        </div>
      </div>
    `;
    
    document.getElementById("referralChart").innerHTML = `
      <div class="placeholder-chart">
        <div class="chart-placeholder-text">Referrals Chart would be here</div>
        <div class="chart-data-placeholder">
          <div>Total Referrals: ${referrals.total}</div>
          <div>Average Per User: ${referrals.average.toFixed(2)}</div>
        </div>
      </div>
    `;
    
  } catch (error) {
    console.error("Error updating analytics:", error);
    
    // Show error in charts
    document.querySelectorAll(".chart").forEach(chart => {
      chart.innerHTML = `<div class="error">Error loading chart data: ${error.message}</div>`;
    });
  }
}

function analyzeUserGrowth(users, cutoff) {
  const newUsers = users.filter(user => {
    const joinDate = user.dateJoined ? new Date(user.dateJoined).getTime() : 0;
    return joinDate > cutoff;
  });
  
  return {
    totalNewUsers: newUsers.length,
    growthRate: users.length > 0 ? ((newUsers.length / users.length) * 100).toFixed(2) : 0
  };
}

function analyzeAirtimeTransactions(users, cutoff) {
  let totalVolume = 0;
  let count = 0;
  
  users.forEach(user => {
    if (user.airtimeHistory) {
      Object.values(user.airtimeHistory).forEach(transaction => {
        if (transaction.timestamp > cutoff) {
          totalVolume += Math.abs(parseFloat(transaction.amount) || 0);
          count++;
        }
      });
    }
  });
  
  return {
    totalVolume,
    count
  };
}

function analyzeActiveUsers(users, cutoff) {
  const activeUsers = users.filter(user => {
    return (
      (user.status === "active" || !user.status) && 
      (user.lastLogin && user.lastLogin > cutoff)
    );
  });
  
  return {
    count: activeUsers.length,
    rate: users.length > 0 ? (activeUsers.length / users.length) * 100 : 0
  };
}

function analyzeReferrals(users, cutoff) {
  let total = 0;
  let usersWithReferrals = 0;
  
  users.forEach(user => {
    const referrals = parseInt(user.referrals || 0);
    total += referrals;
    
    if (referrals > 0) {
      usersWithReferrals++;
    }
  });
  
  return {
    total,
    average: usersWithReferrals > 0 ? total / usersWithReferrals : 0
  };
}

function updateSummaryStats(users, cutoff) {
  // New Users Count
  const newUsers = users.filter(user => {
    const joinDate = user.dateJoined ? new Date(user.dateJoined).getTime() : 0;
    return joinDate > cutoff;
  }).length;
  
  // Airtime Volume
  let airtimeVolume = 0;
  users.forEach(user => {
    if (user.airtimeHistory) {
      Object.values(user.airtimeHistory).forEach(transaction => {
        if (transaction.timestamp > cutoff) {
          airtimeVolume += Math.abs(parseFloat(transaction.amount) || 0);
        }
      });
    }
  });
  
  // Active Users Percentage
  const activeUsers = users.filter(user => {
    return (
      (user.status === "active" || !user.status) && 
      (user.lastLogin && user.lastLogin > cutoff)
    );
  }).length;
  
  const activeUsersPct = users.length > 0 ? (activeUsers / users.length) * 100 : 0;
  
  // Referral Count
  let referralCount = 0;
  users.forEach(user => {
    referralCount += parseInt(user.referrals || 0);
  });
  
  // Update UI
  document.getElementById("newUsersCount").textContent = newUsers;
  document.getElementById("airtimeVolume").textContent = airtimeVolume.toFixed(2);
  document.getElementById("activeUsersPct").textContent = activeUsersPct.toFixed(2) + '%';
  document.getElementById("referralCount").textContent = referralCount;
}

// Initialize the admin dashboard
document.addEventListener('DOMContentLoaded', function() {
  // Load analytics data on tab click
  document.querySelector('[data-tab="analytics"]').addEventListener('click', function() {
    updateAnalytics();
  });
  
  // Load settings data
  async function loadSettings() {
    try {
      // Get referral bonus
      const referralBonusSnapshot = await db.ref("admin/settings/referralBonus").get();
      if (referralBonusSnapshot.exists()) {
        document.getElementById("referralBonus").value = referralBonusSnapshot.val();
      }
      
      // Get system status
      const systemStatusSnapshot = await db.ref("admin/settings/systemStatus").get();
      if (systemStatusSnapshot.exists()) {
        document.getElementById("systemStatus").value = systemStatusSnapshot.val();
      }
    } catch (error) {
      console.error("Error loading settings:", error);
    }
  }
  
  // Load settings when settings tab is clicked
  document.querySelector('[data-tab="settings"]').addEventListener('click', function() {
    loadSettings();
  });
});

// Add event listeners for modals to close when clicking outside
window.addEventListener('click', function(event) {
  const deviceModal = document.getElementById('deviceManagementModal');
  const securityLogsModal = document.getElementById('securityLogsModal');
  
  if (event.target === deviceModal) {
    closeDeviceModal();
  }
  
  if (event.target === securityLogsModal) {
    closeSecurityLogsModal();
  }
});
</script>
<script>
  function switchTheme() {
    if (location.href.includes("admin-phonk")) {
      localStorage.setItem("admin-theme", "default");
      location.href = "admin.html";
    } else {
      localStorage.setItem("admin-theme", "phonk");
      location.href = "admin-phonk.html";
    }
  }

  window.onload = function () {
    const preferred = localStorage.getItem("admin-theme");
    if (preferred === "phonk" && !location.href.includes("admin-phonk")) {
      location.href = "admin-phonk.html";
    } else if (preferred === "default" && !location.href.includes("admin.html")) {
      location.href = "admin.html";
    }
  };
</script>
</body>
</html>
