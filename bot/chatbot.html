<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi Games Chat Assistant</title>
    <style>
        :root {
    --primary-color: #10b981; /* Changed from purple (#6366f1) to green */
    --primary-hover: #059669; /* Darker green for hover state */
    --secondary-color: #94a3b8;
    --background-color: #f1f5f9;
    --chat-bg: #ffffff;
    --user-message-bg: #dcfce7; /* Light green background for user messages */
    --bot-message-bg: #f8fafc;
    --text-color: #334155;
    --border-color: #e2e8f0;
    --shadow-color: rgba(15, 23, 42, 0.08);
    --shadow-color-strong: rgba(15, 23, 42, 0.16);
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    margin: 0;
    padding: 0;
    height: 100vh;
    width: 100vw;
    display: flex;
    flex-direction: column;
    background-color: var(--background-color);
    color: var(--text-color);
    line-height: 1.5;
    overflow: hidden;
}

/* Header */
.header {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
    color: white;
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px var(--shadow-color);
    z-index: 10;
}

.app-title {
    font-weight: 600;
    font-size: 1.25rem;
    margin: 0;
    letter-spacing: 0.01em;
    margin-left: 40px;
}

#network-status {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #10b981; /* Green for online */
    transition: background-color 0.5s;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
    margin-left: 12px;
}

#network-status.offline {
    background-color: #ef4444; /* Red for offline */
}

.status-container {
    display: flex;
    align-items: center;
}

.status-text {
    font-size: 0.85rem;
    opacity: 0.9;
    margin-right: 8px;
}

/* Main chat container */
.main-container {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
}

/* Chat messages area */
#chat-messages {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
    scroll-behavior: smooth;
    max-width: 800px;
    margin: 0 auto; /* Centers the container */
    width: 100%;
    box-sizing: border-box; /* Ensures padding is included in width calculation */
}

#chat-messages::-webkit-scrollbar {
    width: 6px;
}

#chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

#chat-messages::-webkit-scrollbar-thumb {
    background-color: var(--border-color);
    border-radius: 20px;
}

/* Speech bubble message styles */
.message {
    padding: 12px 16px;
    border-radius: 12px;
    max-width: 80%;
    width: fit-content;
    word-wrap: break-word;
    font-size: 0.95rem;
    line-height: 1.5;
    box-shadow: 0 1px 2px var(--shadow-color);
    animation: fadeIn 0.3s forwards;
    box-sizing: border-box;
    position: relative; /* For the speech bubble pointer */
}

.bot-message {
    background-color: var(--bot-message-bg);
    border: 1px solid var(--border-color);
    align-self: flex-start;
    color: var(--text-color);
    border-radius: 12px 12px 12px 0; /* Rounded corners except bottom left */
}

.bot-message::before {
    content: "";
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 0;
    height: 0;
    border-left: 0px solid transparent;
    border-right: 12px solid transparent;
    border-top: 10px solid var(--bot-message-bg);
    border-bottom: 0;
    transform: rotate(180deg); /* Flip to point upward */
}

.user-message {
    background-color: var(--user-message-bg);
    border: 1px solid rgba(16, 185, 129, 0.2); /* Green border to match theme */
    color: #1e293b;
    align-self: flex-end;
    border-radius: 12px 12px 0 12px; /* Rounded corners except bottom right */
}

.user-message::before {
    content: "";
    position: absolute;
    bottom: -10px;
    right: 0;
    width: 0;
    height: 0;
    border-left: 12px solid transparent;
    border-right: 0px solid transparent;
    border-top: 10px solid var(--user-message-bg);
    border-bottom: 0;
    transform: rotate(180deg); /* Flip to point upward */
}

/* Quick responses */
.quick-responses {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
    width: 100%;
    justify-content: left; /* Center the quick responses */
}

.quick-response {
    background-color: rgba(16, 185, 129, 0.1); /* Light green background */
    color: var(--primary-color);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    animation: fadeIn 0.3s forwards;
    border: 1px solid rgba(16, 185, 129, 0.2); /* Green border */
    font-weight: 500;
}

.quick-response:hover {
    background-color: rgba(16, 185, 129, 0.15);
    transform: translateY(-1px);
}

.quick-response:active {
    transform: translateY(1px);
}

/* Typing indicator */
#typing-indicator {
    display: none;
    padding: 12px 16px;
    background-color: var(--bot-message-bg);
    border-radius: 12px;
    width: fit-content;
    margin-bottom: 8px;
    align-self: flex-start;
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 2px var(--shadow-color);
    border-radius: 12px 12px 12px 0; /* Match bot message style */
    position: relative;
}

#typing-indicator::before {
    content: "";
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 0;
    height: 0;
    border-left: 0px solid transparent;
    border-right: 12px solid transparent;
    border-top: 10px solid var(--bot-message-bg);
    border-bottom: 0;
    transform: rotate(180deg); /* Flip to point upward */
}

.typing-dots {
    display: flex;
    gap: 4px;
    padding: 4px 0;
}

.dot {
    width: 8px;
    height: 8px;
    background-color: var(--secondary-color);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
}

.dot:nth-child(2) {
    animation-delay: 0.2s;
}

.dot:nth-child(3) {
    animation-delay: 0.4s;
}

/* Chat input area */
.chat-input-container {
    padding: 24px;
    background-color: var(--chat-bg);
    border-top: 1px solid var(--border-color);
    position: relative;
}

.chat-input-area {
    display: flex;
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
}

#user-input {
    flex: 1;
    padding: 16px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    outline: none;
    font-size: 1rem;
    transition: all 0.2s;
    background-color: var(--background-color);
    color: var(--text-color);
    box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.05);
}

#user-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); /* Green glow */
}

#send-btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    width: 48px;
    height: 48px;
    border-radius: 8px;
    margin-left: 12px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.2s;
    box-shadow: 0 2px 4px var(--shadow-color);
}

#send-btn:hover {
    background-color: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 3px 6px var(--shadow-color);
}

#send-btn:active {
    transform: translateY(1px);
    box-shadow: 0 1px 2px var(--shadow-color);
}

/* Welcome message */
.welcome-container {
    text-align: center;
    padding: 20px;
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    justify-content: center;
    height: 100%;
}

.welcome-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 16px;
    background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.welcome-text {
    font-size: 1.1rem;
    margin-bottom: 32px;
    color: var(--secondary-color);
}

/* Placeholder text for empty chat */
.empty-chat-placeholder {
    text-align: center;
    color: var(--secondary-color);
    margin-top: auto;
    margin-bottom: auto;
    font-size: 1.1rem;
    opacity: 0.7;
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(0.7);
        opacity: 0.5;
    }
    50% {
        transform: scale(1);
        opacity: 1;
    }
}

/* For small screens */
@media (max-width: 640px) {
    #chat-messages {
        padding: 16px;
    }
    
    .chat-input-container {
        padding: 16px;
    }
    
    .message {
        max-width: 90%;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    :root {
        --background-color: #0f172a;
        --chat-bg: #1e293b;
        --user-message-bg: #064e3b; /* Darker green for dark mode */
        --bot-message-bg: #334155;
        --text-color: #e2e8f0;
        --border-color: #475569;
        --shadow-color: rgba(0, 0, 0, 0.2);
        --shadow-color-strong: rgba(0, 0, 0, 0.3);
    }
    
    #user-input {
        background-color: #1e293b;
        color: #e2e8f0;
        border-color: #475569;
    }
    
    .quick-response {
        background-color: rgba(16, 185, 129, 0.15);
        border-color: rgba(16, 185, 129, 0.3);
    }
    
    .user-message {
        color: #f1f5f9;
        border-color: rgba(16, 185, 129, 0.3);
    }
    
    .bot-message {
        border-color: #475569;
    }

    .user-message::before {
        border-top-color: #064e3b; /* Match dark mode user message bg */
    }
}
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1 class="app-title">Multi Games Assistant</h1>
        <div class="status-container">
            <span class="status-text" id="status-text">Online</span>
            <div id="network-status" title="Network Status"></div>
        </div>
    </div>

    <!-- Main container -->
    <div class="main-container">
        <div id="chat-messages">
            <!-- Empty chat placeholder -->
            <div class="empty-chat-placeholder">
                Type a message to start chatting with Multi Games Assistant
            </div>
        </div>

        <div id="typing-indicator">
            <div class="typing-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>

    <!-- Input area -->
    <div class="chat-input-container">
        <div class="chat-input-area">
            <input type="text" id="user-input" placeholder="Type your message..." aria-label="Type your message">
            <button id="send-btn" aria-label="Send message">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
    // Constants
    const GROQ_API_KEY = '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';
    const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';
    const MODEL = 'llama-3.3-70b-versatile';
    const LOCAL_STORAGE_KEY = 'multiGamesChat';
    const MESSAGE_LIMIT = 20; // Maximum number of messages allowed in a 3-hour window
    const TIME_WINDOW = 3 * 60 * 60 * 1000; // 3 hours in milliseconds
    const SITE_URL = 'https://multi-games-fawn.vercel.app/';
    
    // DOM elements
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const typingIndicator = document.getElementById('typing-indicator');
    const networkStatus = document.getElementById('network-status');
    const statusText = document.getElementById('status-text');
    
    // State variables
    let isOnline = navigator.onLine;
    let conversationHistory = [
        { 
            role: "system", 
            content: "You are Multi Games 1.0, a helpful gaming assistant. Provide friendly, concise responses about games, account management, and technical support. Keep responses under 3 sentences when possible. You can provide information about games available at https://multi-games-fawn.vercel.app/." 
        }
    ];
    let isFirstMessage = true;
    let messageCount = 0;
    let chatLimitInfo = {
        count: 0,
        resetTime: Date.now() + TIME_WINDOW
    };
    let siteContent = {};
    
    // Load chat history from local storage
    loadChatFromLocalStorage();
    
    // Set initial network status
    updateNetworkStatus();
    
    // Fetch website content initially
    fetchSiteContent();

    // Event listeners for network status
    window.addEventListener('online', function() {
        updateNetworkStatus();
        fetchSiteContent(); // Refresh site content when going back online
    });
    window.addEventListener('offline', updateNetworkStatus);

    // Send message on button click
    sendBtn.addEventListener('click', sendMessage);

    // Send message on Enter key press
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Function to update network status indicator
    function updateNetworkStatus() {
        isOnline = navigator.onLine;
        if (isOnline) {
            networkStatus.classList.remove('offline');
            networkStatus.title = 'Online - Using Groq API';
            statusText.textContent = 'Online';
        } else {
            networkStatus.classList.add('offline');
            networkStatus.title = 'Offline - Using local responses';
            statusText.textContent = 'Offline';
        }
    }
    
    // Function to fetch content from the website
    async function fetchSiteContent() {
        if (!isOnline) return;
        
        try {
            // Fetch the main page
            const response = await fetch(SITE_URL);
            const html = await response.text();
            
            // Create a temporary DOM element to parse the HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Extract game information
            const gameElements = doc.querySelectorAll('.game-card');
            const games = Array.from(gameElements).map(gameEl => {
                const title = gameEl.querySelector('.game-title')?.textContent || '';
                const description = gameEl.querySelector('.game-desc')?.textContent || '';
                const category = gameEl.querySelector('.game-category')?.textContent || '';
                
                return {
                    title,
                    description,
                    category
                };
            });
            
            // Extract FAQ information
            const faqElements = doc.querySelectorAll('.faq-item');
            const faqs = Array.from(faqElements).map(faqEl => {
                const question = faqEl.querySelector('.faq-question')?.textContent || '';
                const answer = faqEl.querySelector('.faq-answer')?.textContent || '';
                
                return {
                    question,
                    answer
                };
            });
            
            // Store the extracted content
            siteContent = {
                games,
                faqs,
                lastUpdated: Date.now()
            };
            
            // Update the system prompt with the latest site content
            updateSystemPromptWithSiteContent();
            
            console.log('Site content fetched successfully:', siteContent);
        } catch (error) {
            console.error('Failed to fetch site content:', error);
        }
    }
    
    // Update system prompt with site content
    function updateSystemPromptWithSiteContent() {
        // Only update if we have content
        if (!siteContent.games || siteContent.games.length === 0) return;
        
        // Create a formatted list of games
        const gamesList = siteContent.games.map(game => 
            `${game.title}: ${game.description} (Category: ${game.category})`
        ).join('\\n');
        
        // Create a formatted list of FAQs
        const faqsList = siteContent.faqs?.map(faq => 
            `Q: ${faq.question}\\nA: ${faq.answer}`
        ).join('\\n\\n') || '';
        
        // Update the system message
        conversationHistory[0] = { 
            role: "system", 
            content: `You are Multi Games 1.0, a helpful gaming assistant. Provide friendly, concise responses about games, account management, and technical support. Keep responses under 3 sentences when possible.
            
Available games from https://multi-games-fawn.vercel.app/:
${gamesList}

FAQs:
${faqsList}

Remember to enforce chat limits strictly. After 20 messages in a 3-hour window, inform users they've reached their limit and must wait until the reset time.`
        };
    }

    // Load chat history from local storage
    function loadChatFromLocalStorage() {
        const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            
            // Load conversation history
            if (parsedData.conversationHistory && parsedData.conversationHistory.length > 1) {
                conversationHistory = parsedData.conversationHistory;
                isFirstMessage = false;
                
                // Clear placeholder
                chatMessages.innerHTML = '';
                
                // Display previous messages
                parsedData.displayMessages.forEach(msg => {
                    if (msg.type === 'user') {
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('message', 'user-message');
                        messageElement.textContent = msg.content;
                        chatMessages.appendChild(messageElement);
                    } else if (msg.type === 'bot') {
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('message', 'bot-message');
                        messageElement.textContent = msg.content;
                        chatMessages.appendChild(messageElement);
                    } else if (msg.type === 'limit') {
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('message', 'bot-message', 'limit-message');
                        messageElement.textContent = msg.content;
                        chatMessages.appendChild(messageElement);
                    }
                });
                
                // Show latest quick responses if available
                if (parsedData.lastQuickResponses && parsedData.lastQuickResponses.length > 0) {
                    showQuickResponses(parsedData.lastQuickResponses);
                }
            }
            
            // Load chat limit info
            if (parsedData.chatLimitInfo) {
                // Check if the reset time has passed
                if (Date.now() > parsedData.chatLimitInfo.resetTime) {
                    // Reset the counter if the time has passed
                    chatLimitInfo = {
                        count: 0,
                        resetTime: Date.now() + TIME_WINDOW
                    };
                } else {
                    chatLimitInfo = parsedData.chatLimitInfo;
                }
            }
            
            // Load site content if available
            if (parsedData.siteContent && parsedData.siteContent.lastUpdated) {
                // Only use cached site content if it's less than 1 hour old
                const ONE_HOUR = 60 * 60 * 1000;
                if (Date.now() - parsedData.siteContent.lastUpdated < ONE_HOUR) {
                    siteContent = parsedData.siteContent;
                    updateSystemPromptWithSiteContent();
                }
            }
        }
    }

    // Save chat to local storage
    function saveChatToLocalStorage() {
        // Create an array of display messages for rendering
        const displayMessages = [];
        
        // Get all message elements from the DOM
        const messageElements = chatMessages.querySelectorAll('.message');
        messageElements.forEach(element => {
            if (element.classList.contains('user-message')) {
                displayMessages.push({
                    type: 'user',
                    content: element.textContent
                });
            } else if (element.classList.contains('limit-message')) {
                displayMessages.push({
                    type: 'limit',
                    content: element.textContent
                });
            } else if (element.classList.contains('bot-message')) {
                displayMessages.push({
                    type: 'bot',
                    content: element.textContent
                });
            }
        });
        
        // Get quick responses if any
        const quickResponsesContainer = chatMessages.querySelector('.quick-responses');
        let lastQuickResponses = [];
        
        if (quickResponsesContainer) {
            const quickResponseElements = quickResponsesContainer.querySelectorAll('.quick-response');
            lastQuickResponses = Array.from(quickResponseElements).map(el => el.textContent);
        }
        
        // Create data object to save
        const dataToSave = {
            conversationHistory: conversationHistory,
            displayMessages: displayMessages,
            chatLimitInfo: chatLimitInfo,
            lastQuickResponses: lastQuickResponses,
            siteContent: siteContent
        };
        
        // Save to local storage
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
    }

    // Function to send message
    function sendMessage() {
        const message = userInput.value.trim();
        if (message !== '') {
            // Check if chat limit has been reached
            if (chatLimitInfo.count >= MESSAGE_LIMIT) {
                // Check if the reset time has passed
                if (Date.now() > chatLimitInfo.resetTime) {
                    // Reset the counter if the time has passed
                    chatLimitInfo = {
                        count: 0,
                        resetTime: Date.now() + TIME_WINDOW
                    };
                } else {
                    // Show limit message and block further messages
                    showChatLimitMessage();
                    return;
                }
            }
            
            // Clear the placeholder text if this is the first message
            if (isFirstMessage) {
                chatMessages.innerHTML = '';
                isFirstMessage = false;
            }
            
            // Add user message to chat
            addUserMessage(message);
            // Add to conversation history
            conversationHistory.push({ role: "user", content: message });
            // Clear input
            userInput.value = '';
            // Show typing indicator
            showTypingIndicator();
            
            // Increment chat limit counter
            chatLimitInfo.count++;
            
            // Process the message based on network status
            if (isOnline) {
                // Use Groq API for online responses
                getGroqResponse(message);
            } else {
                // Use local responses for offline mode
                setTimeout(() => {
                    processLocalMessage(message);
                }, 1000);
            }
            
            // Save to local storage
            saveChatToLocalStorage();
        }
    }

    // Function to show chat limit message
    function showChatLimitMessage() {
        // Remove any existing quick responses
        const existingQuickResponses = chatMessages.querySelector('.quick-responses');
        if (existingQuickResponses) {
            existingQuickResponses.remove();
        }
        
        const limitMessage = document.createElement('div');
        limitMessage.classList.add('message', 'bot-message', 'limit-message');
        
        // Calculate time remaining until reset
        const timeRemaining = chatLimitInfo.resetTime - Date.now();
        const hoursRemaining = Math.floor(timeRemaining / (60 * 60 * 1000));
        const minutesRemaining = Math.floor((timeRemaining % (60 * 60 * 1000)) / (60 * 1000));
        
        limitMessage.innerHTML = `
            <div class="limit-icon">⚠️</div>
            <div class="limit-text">
                <strong>Chat Limit Reached</strong><br>
                You've reached your chat limit for now. You can send more messages in ${hoursRemaining} hours and ${minutesRemaining} minutes. Thank you for using Multi Games Assistant!
            </div>
        `;
        chatMessages.appendChild(limitMessage);
        
        // Add some styling with CSS
        const style = document.createElement('style');
        style.textContent = `
            .limit-message {
                background-color: #fff3cd;
                border: 1px solid #ffeeba;
                color: #856404;
                display: flex;
                align-items: center;
                padding: 12px;
            }
            .limit-icon {
                font-size: 24px;
                margin-right: 12px;
            }
            .limit-text {
                flex: 1;
            }
        `;
        document.head.appendChild(style);
        
        scrollToBottom();
        
        // Disable input temporarily and add visual indicator
        userInput.disabled = true;
        userInput.placeholder = "Chat limit reached. Please wait for reset...";
        userInput.style.backgroundColor = "#f8f9fa";
        sendBtn.disabled = true;
        
        // Save to local storage
        saveChatToLocalStorage();
        
        // Set a timer to check if the limit has reset
        setTimeout(checkLimitReset, 60000); // Check every minute
    }
    
    // Function to check if the chat limit has reset
    function checkLimitReset() {
        if (Date.now() > chatLimitInfo.resetTime) {
            // Reset the counter
            chatLimitInfo = {
                count: 0,
                resetTime: Date.now() + TIME_WINDOW
            };
            
            // Enable input
            userInput.disabled = false;
            userInput.placeholder = "Type your message here...";
            userInput.style.backgroundColor = "";
            sendBtn.disabled = false;
            
            // Add a message that the limit has been reset
            const resetMessage = document.createElement('div');
            resetMessage.classList.add('message', 'bot-message');
            resetMessage.textContent = "Your chat limit has been reset. You can now continue chatting!";
            chatMessages.appendChild(resetMessage);
            
            // Show quick responses
            showQuickResponses(["Game recommendations", "Account help", "Technical support"]);
            
            // Save to local storage
            saveChatToLocalStorage();
        } else {
            // Check again in a minute
            setTimeout(checkLimitReset, 60000);
        }
    }

    // Function to get response from Groq API
    async function getGroqResponse(message) {
        try {
            const response = await fetch(GROQ_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${GROQ_API_KEY}`
                },
                body: JSON.stringify({
                    model: MODEL,
                    messages: conversationHistory,
                    max_tokens: 800,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const data = await response.json();
            const botResponse = data.choices[0].message.content;
            
            // Add bot response to conversation history
            conversationHistory.push({ role: "assistant", content: botResponse });
            
            // Add bot message to chat
            addBotMessage(botResponse);
            
            // Show quick responses based on context
            showContextualQuickResponses(message, botResponse);
            
            // Check if close to limit and show warning
            checkAndShowLimitWarning();
            
            // Save updated chat to local storage
            saveChatToLocalStorage();
            
        } catch (error) {
            console.error('Error fetching from Groq API:', error);
            // Fallback to local processing if API fails
            processLocalMessage(message);
        }
    }
    
    // Check if close to limit and show warning
    function checkAndShowLimitWarning() {
        const warningThreshold = Math.floor(MESSAGE_LIMIT * 0.8); // 80% of limit
        
        if (chatLimitInfo.count === warningThreshold) {
            const remainingMessages = MESSAGE_LIMIT - chatLimitInfo.count;
            const timeRemaining = chatLimitInfo.resetTime - Date.now();
            const hoursRemaining = Math.floor(timeRemaining / (60 * 60 * 1000));
            const minutesRemaining = Math.floor((timeRemaining % (60 * 60 * 1000)) / (60 * 1000));
            
            const warningElement = document.createElement('div');
            warningElement.classList.add('message', 'bot-message', 'warning-message');
            warningElement.innerHTML = `
                <div class="warning-icon">⚠️</div>
                <div class="warning-text">
                    <strong>Approaching Chat Limit</strong><br>
                    You have ${remainingMessages} messages remaining in your current chat session. Your limit will reset in ${hoursRemaining} hours and ${minutesRemaining} minutes.
                </div>
            `;
            
            // Add some styling with CSS
            const style = document.createElement('style');
            style.textContent = `
                .warning-message {
                    background-color: #f8f9fa;
                    border: 1px solid #d6d8db;
                    color: #383d41;
                    display: flex;
                    align-items: center;
                    padding: 12px;
                    margin: 10px 0;
                }
                .warning-icon {
                    font-size: 20px;
                    margin-right: 12px;
                }
                .warning-text {
                    flex: 1;
                }
            `;
            document.head.appendChild(style);
            
            chatMessages.appendChild(warningElement);
            scrollToBottom();
            
            // Save to local storage
            saveChatToLocalStorage();
        }
    }

    // Add a user message to the chat
    function addUserMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', 'user-message');
        messageElement.textContent = message;
        chatMessages.appendChild(messageElement);
        scrollToBottom();
    }

    // Add a bot message to the chat with typing animation
    function addBotMessage(message) {
        hideTypingIndicator();
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', 'bot-message');
        messageElement.textContent = '';
        chatMessages.appendChild(messageElement);
        scrollToBottom();
        
        // Type out the message character by character
        let i = 0;
        const typingSpeed = 20; // milliseconds per character
        const typeWriter = () => {
            if (i < message.length) {
                messageElement.textContent += message.charAt(i);
                i++;
                scrollToBottom();
                setTimeout(typeWriter, typingSpeed);
            } else {
                // Save to local storage after typing is complete
                saveChatToLocalStorage();
            }
        };
        typeWriter();
    }

    // Show quick response options
    function showQuickResponses(responses) {
        // Remove any existing quick responses
        const existingQuickResponses = chatMessages.querySelector('.quick-responses');
        if (existingQuickResponses) {
            existingQuickResponses.remove();
        }
        
        const quickResponsesContainer = document.createElement('div');
        quickResponsesContainer.classList.add('quick-responses');
        
        responses.forEach(response => {
            const responseElement = document.createElement('div');
            responseElement.classList.add('quick-response');
            responseElement.textContent = response;
            responseElement.addEventListener('click', function() {
                // Check chat limit before processing
                if (chatLimitInfo.count >= MESSAGE_LIMIT) {
                    // Check if the reset time has passed
                    if (Date.now() > chatLimitInfo.resetTime) {
                        // Reset the counter if the time has passed
                        chatLimitInfo = {
                            count: 0,
                            resetTime: Date.now() + TIME_WINDOW
                        };
                    } else {
                        // Show limit message
                        showChatLimitMessage();
                        return;
                    }
                }
                
                // Clear the placeholder text if this is the first message
                if (isFirstMessage) {
                    chatMessages.innerHTML = '';
                    isFirstMessage = false;
                }
                
                // Remove quick response options after selection
                quickResponsesContainer.remove();
                
                addUserMessage(response);
                // Add to conversation history
                conversationHistory.push({ role: "user", content: response });
                
                // Increment chat limit counter
                chatLimitInfo.count++;
                
                showTypingIndicator();
                
                // Save to local storage
                saveChatToLocalStorage();
                
                // Process based on network status
                if (isOnline) {
                    getGroqResponse(response);
                } else {
                    setTimeout(() => {
                        processLocalMessage(response);
                    }, 1000);
                }
            });
            quickResponsesContainer.appendChild(responseElement);
        });
        
        chatMessages.appendChild(quickResponsesContainer);
        scrollToBottom();
        
        // Save updated chat with quick responses to local storage
        saveChatToLocalStorage();
    }

    // Show contextual quick responses based on message content and website data
    function showContextualQuickResponses(userMessage, botResponse) {
        const lowerUserMsg = userMessage.toLowerCase();
        const lowerBotMsg = botResponse.toLowerCase();
        
        // Default responses
        let responses = ["Tell me more", "Game recommendations", "Account help"];
        
        // First try to use real games from the website
        if (siteContent.games && siteContent.games.length > 0) {
            // Check if we're discussing a specific game from our site
            const mentionedGame = siteContent.games.find(game => 
                lowerUserMsg.includes(game.title.toLowerCase()) || 
                lowerBotMsg.includes(game.title.toLowerCase())
            );
            
            if (mentionedGame) {
                responses = [
                    `Play ${mentionedGame.title}`, 
                    `${mentionedGame.title} guide`, 
                    "Other similar games"
                ];
            } else if (lowerUserMsg.includes('game') || lowerBotMsg.includes('game')) {
                // Get some random games from the site to recommend
                const gameSample = siteContent.games
                    .sort(() => 0.5 - Math.random()) // Shuffle array
                    .slice(0, 3) // Take first 3 elements after shuffle
                    .map(game => game.title);
                    
                responses = gameSample.length > 0 ? 
                    gameSample : ["Popular games", "New releases", "Game categories"];
            }
        } else {
            // Fallback to hardcoded responses if no site data
            if (lowerUserMsg.includes('game') || lowerBotMsg.includes('game')) {
                if (lowerBotMsg.includes('pixel adventure') || lowerUserMsg.includes('pixel adventure')) {
                    responses = ["Play Pixel Adventure", "Game controls", "Other similar games"];
                } else if (lowerBotMsg.includes('space warriors') || lowerUserMsg.includes('space warriors')) {
                    responses = ["Play Space Warriors", "Ship upgrades", "Multiplayer guide"];
                } else if (lowerBotMsg.includes('mystery dungeon') || lowerUserMsg.includes('mystery dungeon')) {
                    responses = ["Play Mystery Dungeon", "Character classes", "Dungeon tips"];
                } else {
                    responses = ["Popular games", "New releases", "Game categories"];
                }
            }
        }
        
        // Account related responses
        if (lowerUserMsg.includes('account') || lowerBotMsg.includes('account')) {
            responses = ["Create account", "Account benefits", "Password reset"];
        } else if (lowerUserMsg.includes('help') || lowerBotMsg.includes('support')) {
            responses = ["Technical support", "Contact us", "FAQ"];
        }
        
        showQuickResponses(responses);
    }

    // Show typing indicator
    function showTypingIndicator() {
        typingIndicator.style.display = 'block';
        scrollToBottom();
    }

    // Hide typing indicator
    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }

    // Scroll to the bottom of the chat
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Process the user message locally and generate a response (for offline mode)
    function processLocalMessage(message) {
        const lowerMessage = message.toLowerCase();
        
        // Add local response to conversation history
        let botResponse = "";
        
        // Use site content if available
        if (siteContent.games && siteContent.games.length > 0) {
            // Check if asking about games
            if (lowerMessage.includes('game') && (lowerMessage.includes('recommend') || lowerMessage.includes('suggestion'))) {
                // Get 3 random games from the site
                const randomGames = siteContent.games
                    .sort(() => 0.5 - Math.random()) // Shuffle
                    .slice(0, 3); // Take first 3
                
                const gameNames = randomGames.map(game => `'${game.title}'`).join(', ');
                
                botResponse = `Based on our most popular games, I'd recommend checking out ${gameNames}. Would you like more details about any of these?`;
                addBotMessage(botResponse);
                showQuickResponses(randomGames.map(game => `${game.title} details`));
                return;
            }
            
            // Check if asking about a specific game
            const mentionedGame = siteContent.games.find(game => 
                lowerMessage.includes(game.title.toLowerCase())
            );
            
            if (mentionedGame) {
                botResponse = `'${mentionedGame.title}' is ${mentionedGame.description} This game is in the ${mentionedGame.category} category. Would you like to try it out?`;
                addBotMessage(botResponse);
                showQuickResponses([`Play ${mentionedGame.title}`, "Game controls", "Other similar games"]);
                return;
            }
            
            // Check if asking about FAQs
            const mentionedFaq = siteContent.faqs?.find(faq => 
                lowerMessage.includes(faq.question.toLowerCase())
            );
            
            if (mentionedFaq) {
                botResponse = mentionedFaq.answer;
                addBotMessage(botResponse);
                showQuickResponses(["More FAQs", "Account help", "Game recommendations"]);
                return;
            }
        }
        
        // Check for common gaming queries (fallback)
        if (lowerMessage.includes('game') && (lowerMessage.includes('recommend') || lowerMessage.includes('suggestion'))) {
            botResponse = "Based on our most popular games, I'd recommend checking out 'Pixel Adventure', 'Space Warriors', or 'Mystery Dungeon'. Would you like more details about any of these?";
            addBotMessage(botResponse);
            showQuickResponses(["Pixel Adventure details", "Space Warriors details", "Mystery Dungeon details"]);
        }
        else if (lowerMessage.includes('what games') || lowerMessage.includes('available games') || lowerMessage.includes('games do you have')) {
            botResponse = "We have a variety of games across different genres! Some of our popular titles include action games like 'Pixel Adventure' and 'Ninja Run', strategy games like 'Empire Builder', racing games like 'Speed Demons', and many more. You can browse all games by category on our homepage.";
            addBotMessage(botResponse);
            showQuickResponses(["Action games", "Strategy games", "Racing games"]);
        }
        else if (lowerMessage.includes('account') && (lowerMessage.includes('create') || lowerMessage.includes('sign up') || lowerMessage.includes('register'))) {
            botResponse = "Creating an account is easy! Click on the 'Sign Up' button in the top right corner of our website. You'll need to provide an email address, choose a username, and create a password. Verified accounts get access to exclusive games and can save their progress across devices!";
            addBotMessage(botResponse);
            showQuickResponses(["Benefits of account", "Login issues", "Password reset"]);
        }
        else if (lowerMessage.includes('pixel adventure')) {
            botResponse = "'Pixel Adventure' is one of our most popular platformers! It features beautiful pixel art, challenging levels, and collectible items. The game has 4 worlds with 10 levels each. Would you like to try it out?";
            addBotMessage(botResponse);
            showQuickResponses(["Play Pixel Adventure", "Game controls", "Other similar games"]);
        }
        else if (lowerMessage.includes('space warriors')) {
            botResponse = "'Space Warriors' is an exciting space shooter with multiplayer capability. Customize your spaceship, upgrade weapons, and compete against players worldwide. It has stunning graphics and intense gameplay!";
            addBotMessage(botResponse);
            showQuickResponses(["Play Space Warriors", "Ship upgrades", "Multiplayer guide"]);
        }
        else if (lowerMessage.includes('mystery dungeon')) {
            botResponse = "'Mystery Dungeon' is a roguelike adventure with procedurally generated levels, meaning every playthrough is unique! Explore dungeons, collect magical items, and defeat powerful bosses as you uncover the ancient mystery.";
            addBotMessage(botResponse);
            showQuickResponses(["Play Mystery Dungeon", "Character classes", "Dungeon tips"]);
        }
         else if (lowerMessage.includes('login') && (lowerMessage.includes('issue') || lowerMessage.includes('problem') || lowerMessage.includes('can\'t'))) {
            botResponse = "I'm sorry to hear you're having login issues. Here are some common solutions: 1) Make sure caps lock is off 2) Try resetting your password 3) Clear your browser cookies and cache 4) Try a different browser. If none of these work, please contact our support team.";
            addBotMessage(botResponse);
            showQuickResponses(["Reset password", "Contact support", "Create new account"]);
        }
        else if (lowerMessage.includes('payment') || lowerMessage.includes('purchase')) {
            botResponse = "We accept various payment methods including credit/debit cards, PayPal, and gift cards. All transactions are secure and encrypted. For subscription inquiries or payment issues, please contact our support team.";
            addBotMessage(botResponse);
            showQuickResponses(["Premium benefits", "Subscription plans", "Contact support"]);
        }
        else if (lowerMessage.includes('hi') || lowerMessage.includes('hello') || lowerMessage.includes('hey')) {
            botResponse = "Hi there! Welcome to Multi Games. I'm your gaming assistant and I'm here to help you find games, answer questions, and provide support. What can I help you with today?";
            addBotMessage(botResponse);
            showQuickResponses(["Game recommendations", "Account help", "Technical support"]);
        }
        else if (lowerMessage.includes('thank')) {
            botResponse = "You're welcome! I'm glad I could help. Is there anything else you'd like to know about our games or services?";
            addBotMessage(botResponse);
            showQuickResponses(["Game recommendations", "Account help", "No, that's all"]);
        }
        else {
            // Generic response for unrecognized queries
            botResponse = "Thanks for your message! I'm currently in offline mode with limited functionality. Once your internet connection is restored, I'll be able to provide more detailed responses. In the meantime, can I help you with something basic?";
            addBotMessage(botResponse);
            showQuickResponses(["Popular games", "Account basics", "Wait for online mode"]);
        }
        
        // Add bot response to conversation history
        conversationHistory.push({ role: "assistant", content: botResponse });
        
        // Check if close to limit and show warning
        checkAndShowLimitWarning();
        
        // Save updated chat to local storage
        saveChatToLocalStorage();
    }
});
    </script>
</body>
</html>
    