<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi Games - Authentication</title>
    <style>
    :root {
    --primary-color: #10b981;
    --secondary-color: #059669;
    --background-color: #ffffff;
    --card-color: #ffffff;
    --text-color: #111827;
    --text-secondary: #4b5563;
    --error-color: #ef4444;
    --success-color: #10b981;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

body {
    background-color: var(--background-color);
    color: var(--text-color);
    min-height: 100vh;
    width: 100%;
    padding: 0.5rem;
}

/* Removed container width limits for iframe display */
.container {
    width: 100%;
}

.auth-card {
    background-color: var(--card-color);
    border-radius: 0.5rem;
    padding: 1rem;
    width: 100%;
}

/* Logo has been removed */

h1 {
    font-size: 1.25rem;
    text-align: center;
    margin-bottom: 1rem;
    font-weight: 600;
    margin-top: 0; /* Removed top margin */
}

.tabs {
    display: flex;
    margin-bottom: 1rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.tab {
    flex: 1;
    text-align: center;
    padding: 0.5rem;
    cursor: pointer;
    font-weight: 500;
    color: var(--text-secondary);
    position: relative;
    font-size: 0.875rem; /* Reduced font size */
}

.tab.active {
    color: var(--text-color);
}

.tab.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 2px;
    background-color: var(--primary-color);
}

.form-group {
    margin-bottom: 0.75rem; /* Reduced margin */
}

label {
    display: block;
    margin-bottom: 0.25rem; /* Reduced margin */
    font-size: 0.8rem; /* Reduced font size */
    font-weight: 500;
}

input {
    width: 100%;
    padding: 0.5rem; /* Reduced padding */
    border-radius: 0.5rem;
    background-color: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: var(--text-color);
    font-size: 0.9rem; /* Reduced font size */
    transition: border-color 0.2s;
}

input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 1px var(--primary-color);
}

button {
    width: 100%;
    padding: 0.6rem; /* Reduced padding */
    border-radius: 0.5rem;
    background-color: var(--primary-color);
    color: white;
    font-weight: 500;
    border: none;
    cursor: pointer;
    font-size: 0.9rem; /* Reduced font size */
    transition: background-color 0.2s;
    margin-top: 0.75rem; /* Reduced margin */
}

button:hover {
    background-color: var(--secondary-color);
}

button:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
}

.forgot-password {
    text-align: right;
    margin-top: 0.25rem; /* Reduced margin */
}

.forgot-password a {
    color: var(--primary-color);
    font-size: 0.8rem; /* Reduced font size */
    text-decoration: none;
    cursor: pointer;
}

.forgot-password a:hover {
    text-decoration: underline;
}

.form-section {
    display: none;
}

.form-section.active {
    display: block;
}

.referral-container {
    margin-top: 0.75rem; /* Reduced margin */
    padding-top: 0.75rem; /* Reduced padding */
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.error-message {
    color: var(--error-color);
    font-size: 0.8rem; /* Reduced font size */
    margin-top: 0.25rem; /* Reduced margin */
    display: none;
}

.success-message {
    color: var(--success-color);
    font-size: 0.8rem; /* Reduced font size */
    margin-top: 0.25rem; /* Reduced margin */
    display: none;
}

.loading {
    display: inline-block;
    width: 16px; /* Reduced size */
    height: 16px; /* Reduced size */
    border: 2px solid rgba(255, 255, 255, 0.3); /* Reduced border */
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s linear infinite;
    margin-right: 6px; /* Reduced margin */
    display: none;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.btn-with-loading {
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Verification Challenge Styles */
.verification-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.verification-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.verification-container {
    background-color: var(--background-color);
    padding: 1.5rem; /* Reduced padding */
    border-radius: 0.75rem;
    width: 95%; /* Increased width for iframe */
    max-width: 400px;
}

.verification-header {
    text-align: center;
    margin-bottom: 1rem; /* Reduced margin */
}

.verification-header h3 {
    font-size: 1.1rem; /* Reduced font size */
    margin-bottom: 0.25rem; /* Reduced margin */
}

.verification-header p {
    color: var(--text-secondary);
    font-size: 0.8rem; /* Reduced font size */
}

.challenge-container {
    margin-bottom: 1rem; /* Reduced margin */
}

.challenge-container p {
    font-size: 1rem; /* Reduced font size */
    margin-bottom: 0.75rem; /* Reduced margin */
    text-align: center;
}

.answer-input {
    width: 100%;
    padding: 0.6rem; /* Reduced padding */
    border-radius: 0.5rem;
    text-align: center;
    font-size: 1.1rem; /* Reduced font size */
    letter-spacing: 2px;
}

.answer-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 1px var(--primary-color);
}

.timer-container {
    text-align: center;
    margin-bottom: 0.75rem; /* Reduced margin */
}

.timer {
    font-size: 0.9rem; /* Reduced font size */
    color: var(--text-secondary);
}

.progress-bar {
    height: 4px; /* Reduced height */
    background-color: rgba(0, 0, 0, 0.1);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 0.25rem; /* Reduced margin */
}

.progress-fill {
    height: 100%;
    background-color: var(--primary-color);
    width: 100%;
    transition: width 1s linear;
}

.challenge-image {
    display: block;
    margin: 0 auto 0.75rem; /* Reduced margin */
    max-width: 100%;
    height: auto;
}

.verify-button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 0.6rem; /* Reduced padding */
    border-radius: 0.5rem;
    width: 100%;
    font-size: 0.9rem; /* Reduced font size */
    font-weight: 500;
    cursor: pointer;
}

.verify-button:hover {
    background-color: var(--secondary-color);
}
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-card">
            <div class="logo">
                <!-- You can add your logo here -->
                <h2>Multi Games</h2>
            </div>
            
            <div class="tabs">
                <div class="tab active" id="tab-login">Login</div>
                <div class="tab" id="tab-signup">Sign Up</div>
                <div class="tab" id="tab-forgot">Forgot Password</div>
            </div>
            
            <!-- Login Form -->
            <div class="form-section active" id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                </div>
                <div class="error-message" id="login-error"></div>
                <button id="login-button" class="btn-with-loading">
                    <span class="loading" id="login-loading"></span>
                    <span>Login</span>
                </button>
            </div>
            
            <!-- Sign Up Form -->
            <div class="form-section" id="signup-form">
                <div class="form-group">
                    <label for="signup-fullname">Full Name</label>
                    <input type="text" id="signup-fullname" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="signup-username">Username</label>
                    <input type="text" id="signup-username" placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="signup-confirm-password">Confirm Password</label>
                    <input type="password" id="signup-confirm-password" placeholder="Confirm your password">
                </div>
                <div class="form-group referral-container">
                    <label for="signup-referral">Referral Code (Optional)</label>
                    <input type="text" id="signup-referral" placeholder="Enter referral code if you have one">
                </div>
                <div class="error-message" id="signup-error"></div>
                <div class="success-message" id="signup-success"></div>
                <button id="signup-button" class="btn-with-loading">
                    <span class="loading" id="signup-loading"></span>
                    <span>Create Account</span>
                </button>
            </div>
            
            <!-- Forgot Password Form -->
            <div class="form-section" id="forgot-form">
                <div class="form-group">
                    <label for="forgot-email">Email</label>
                    <input type="email" id="forgot-email" placeholder="Enter your email">
                </div>
                <div class="error-message" id="forgot-error"></div>
                <div class="success-message" id="forgot-success"></div>
                <button id="forgot-button" class="btn-with-loading">
                    <span class="loading" id="forgot-loading"></span>
                    <span>Reset Password</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Verification Challenge Overlay -->
    <div class="verification-overlay" id="verification-overlay">
        <div class="verification-container">
            <div class="verification-header">
                <h3>Verification Required</h3>
                <p>Please complete this challenge to continue</p>
            </div>
            <div class="timer-container">
                <div class="timer" id="verification-timer">Time remaining: 30s</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            <div class="challenge-container" id="challenge-container">
                <!-- Challenge content will be dynamically inserted here -->
            </div>
            <button class="verify-button" id="verify-button">Verify</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>

    <script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyBw1uA-kNKOZEufWKZ9AMBxvRGHNGF1lkA",
    authDomain: "multi-games-a2561.firebaseapp.com",
    projectId: "multi-games-a2561",
    storageBucket: "multi-games-a2561.appspot.com",
    messagingSenderId: "150551898066",
    appId: "1:150551898066:web:4e8fb185f2321ba4140a0b",
    measurementId: "G-PB8Y87E6XV",
    databaseURL: "https://multi-games-a2561-default-rtdb.firebaseio.com"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// Tab switching functionality
const tabs = document.querySelectorAll('.tab');
const formSections = document.querySelectorAll('.form-section');

tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        // Remove active class from all tabs and forms
        tabs.forEach(t => t.classList.remove('active'));
        formSections.forEach(f => f.classList.remove('active'));
        
        // Add active class to clicked tab
        tab.classList.add('active');
        
        // Show corresponding form
        const formId = tab.id.replace('tab-', '') + '-form';
        document.getElementById(formId).classList.add('active');
        
        // Clear error messages
        document.querySelectorAll('.error-message').forEach(el => {
            el.style.display = 'none';
        });
        
        // Clear success messages
        document.querySelectorAll('.success-message').forEach(el => {
            el.style.display = 'none';
        });
    });
});

// Generate a random referral code
function generateReferralCode(length = 6) {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return result;
}

// Show loading state
function showLoading(buttonId, loadingId) {
    document.getElementById(buttonId).disabled = true;
    document.getElementById(loadingId).style.display = 'inline-block';
}

// Hide loading state
function hideLoading(buttonId, loadingId) {
    document.getElementById(buttonId).disabled = false;
    document.getElementById(loadingId).style.display = 'none';
}

// Show error message
function showError(elementId, message) {
    const errorElement = document.getElementById(elementId);
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

// Show success message
function showSuccess(elementId, message) {
    const successElement = document.getElementById(elementId);
    successElement.textContent = message;
    successElement.style.display = 'block';
}

// Send user data to parent window
function notifyParentOfLogin(user) {
    window.parent.postMessage({
        type: 'loginSuccess',
        userData: {
            displayName: user.displayName || ''
        }
    }, window.location.origin);
}

// ----- Verification Challenge System -----
const verificationOverlay = document.getElementById('verification-overlay');
const challengeContainer = document.getElementById('challenge-container');
const verifyButton = document.getElementById('verify-button');
const progressFill = document.getElementById('progress-fill');
const timerDisplay = document.getElementById('verification-timer');

let currentChallenge = null;
let verificationTimer = null;
let timerSeconds = 30;
let verificationCallback = null;

// Challenge types
const challengeTypes = [
    {
        type: 'math',
        generate: () => {
            const operations = ['+', '-', '*'];
            const operation = operations[Math.floor(Math.random() * operations.length)];
            
            let num1, num2, answer;
            
            if (operation === '+') {
                num1 = Math.floor(Math.random() * 50) + 10;
                num2 = Math.floor(Math.random() * 50) + 10;
                answer = num1 + num2;
            } else if (operation === '-') {
                num1 = Math.floor(Math.random() * 50) + 30;
                num2 = Math.floor(Math.random() * 20) + 5;
                answer = num1 - num2;
            } else {
                num1 = Math.floor(Math.random() * 10) + 2;
                num2 = Math.floor(Math.random() * 10) + 2;
                answer = num1 * num2;
            }
            
            return {
                question: `What is ${num1} ${operation} ${num2}?`,
                answer: answer.toString()
            };
        },
        render: (challenge) => {
            return `
                <p>${challenge.question}</p>
                <input type="text" class="answer-input" id="challenge-answer" placeholder="Enter answer">
            `;
        }
    },
    {
        type: 'word',
        generate: () => {
            const words = [
                'game', 'play', 'score', 'level', 'winner', 
                'player', 'bonus', 'match', 'multi', 'luck',
                'skill', 'prize', 'power', 'challenge', 'reward'
            ];
            const word = words[Math.floor(Math.random() * words.length)];
            return {
                question: `Type the word: <strong>${word}</strong>`,
                answer: word.toLowerCase()
            };
        },
        render: (challenge) => {
            return `
                <p>${challenge.question}</p>
                <input type="text" class="answer-input" id="challenge-answer" placeholder="Type the word">
            `;
        }
    },
    {
        type: 'sequence',
        generate: () => {
            const sequences = [
                {seq: [2, 4, 6, 8], next: 10},
                {seq: [1, 3, 5, 7], next: 9},
                {seq: [3, 6, 9, 12], next: 15},
                {seq: [2, 4, 8, 16], next: 32},
                {seq: [1, 4, 9, 16], next: 25}
            ];
            
            const selected = sequences[Math.floor(Math.random() * sequences.length)];
            
            return {
                question: `What is the next number in this sequence? ${selected.seq.join(', ')}, ...`,
                answer: selected.next.toString()
            };
        },
        render: (challenge) => {
            return `
                <p>${challenge.question}</p>
                <input type="text" class="answer-input" id="challenge-answer" placeholder="Enter next number">
            `;
        }
    }
];

// Start verification challenge
function startVerification(callback) {
    // Select a random challenge type
    const challengeType = challengeTypes[Math.floor(Math.random() * challengeTypes.length)];
    
    // Generate the challenge
    currentChallenge = challengeType.generate();
    
    // Render the challenge
    challengeContainer.innerHTML = challengeType.render(currentChallenge);
    
    // Store the callback
    verificationCallback = callback;
    
    // Reset and start the timer
    timerSeconds = 30;
    updateTimer();
    startTimer();
    
    // Show the overlay
    verificationOverlay.classList.add('active');
    
    // Add enter key listener to the answer input
    const answerInput = document.getElementById('challenge-answer');
    if (answerInput) {
        answerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyAnswer();
            }
        });
        
        // Focus on the input
        setTimeout(() => {
            answerInput.focus();
        }, 300);
    }
}

// Start the timer
function startTimer() {
    // Clear any existing timer
    if (verificationTimer) {
        clearInterval(verificationTimer);
    }
    
    progressFill.style.width = '100%';
    
    // Start a new timer
    verificationTimer = setInterval(() => {
        timerSeconds--;
        updateTimer();
        
        // Update progress bar
        const percentage = (timerSeconds / 30) * 100;
        progressFill.style.width = `${percentage}%`;
        
        if (timerSeconds <= 0) {
            clearInterval(verificationTimer);
            // Time's up - refresh the challenge
            refreshChallenge();
        }
    }, 1000);
}

// Update the timer display
function updateTimer() {
    timerDisplay.textContent = `Time remaining: ${timerSeconds}s`;
}

// Refresh the challenge
function refreshChallenge() {
    // Select a random challenge type
    const challengeType = challengeTypes[Math.floor(Math.random() * challengeTypes.length)];
    
    // Generate the challenge
    currentChallenge = challengeType.generate();
    
    // Render the challenge
    challengeContainer.innerHTML = challengeType.render(currentChallenge);
    
    // Reset and start the timer
    timerSeconds = 30;
    updateTimer();
    startTimer();
    
    // Focus on the input
    const answerInput = document.getElementById('challenge-answer');
    if (answerInput) {
        setTimeout(() => {
            answerInput.focus();
        }, 100);
    }
}

// Verify the answer
function verifyAnswer() {
    const answerInput = document.getElementById('challenge-answer');
    const userAnswer = answerInput.value.trim().toLowerCase();
    
    if (userAnswer === currentChallenge.answer.toLowerCase()) {
        // Correct answer
        clearInterval(verificationTimer);
        verificationOverlay.classList.remove('active');
        
        // Call the callback function
        if (verificationCallback) {
            verificationCallback();
            verificationCallback = null;
        }
    } else {
        // Wrong answer - refresh the challenge
        answerInput.value = '';
        answerInput.classList.add('shake');
        setTimeout(() => {
            answerInput.classList.remove('shake');
        }, 500);
        refreshChallenge();
    }
}

// Add event listener to the verify button
verifyButton.addEventListener('click', verifyAnswer);

// Login functionality with verification
document.getElementById('login-button').addEventListener('click', () => {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    if (!email || !password) {
        showError('login-error', 'Please enter both email and password');
        return;
    }
    
    // Start verification before processing login
    startVerification(() => {
        showLoading('login-button', 'login-loading');
        
        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Update last login timestamp
                const userId = userCredential.user.uid;
                const lastLoginUpdate = {
                    lastLogin: new Date().toISOString()
                };
                
                database.ref(`users/${userId}`).update(lastLoginUpdate)
                    .then(() => {
                        // Instead of redirecting, send message to parent window
                        hideLoading('login-button', 'login-loading');
                        showSuccess('login-success', 'Login successful!');
                        notifyParentOfLogin(userCredential.user);
                    })
                    .catch((error) => {
                        console.error("Error updating last login:", error);
                        // Still notify parent even if updating timestamp fails
                        hideLoading('login-button', 'login-loading');
                        showSuccess('login-success', 'Login successful!');
                        notifyParentOfLogin(userCredential.user);
                    });
            })
            .catch((error) => {
                hideLoading('login-button', 'login-loading');
                let errorMessage = 'Login failed. Please check your credentials.';
                
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Invalid email or password';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many attempts. Please try again later';
                }
                
                showError('login-error', errorMessage);
            });
    });
});

// Sign up functionality with verification
document.getElementById('signup-button').addEventListener('click', () => {
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    const confirmPassword = document.getElementById('signup-confirm-password').value;
    const fullName = document.getElementById('signup-fullname').value;
    const username = document.getElementById('signup-username').value;
    const referredBy = document.getElementById('signup-referral').value;
    
    // Validation
    if (!email || !password || !confirmPassword || !fullName || !username) {
        showError('signup-error', 'Please fill in all required fields');
        return;
    }
    
    if (password !== confirmPassword) {
        showError('signup-error', 'Passwords do not match');
        return;
    }
    
    if (password.length < 6) {
        showError('signup-error', 'Password must be at least 6 characters');
        return;
    }
    
    // Start verification before processing sign up
    startVerification(() => {
        showLoading('signup-button', 'signup-loading');
        
        // Create user account
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;
                const userId = user.uid;
                const referralCode = generateReferralCode();
                const photoURL = ''; // Default empty photo URL
                
                // Create user profile in database
                const userData = {
                    email: user.email,
                    fullName: fullName,
                    username: username,
                    photoURL: photoURL,
                    walletBalance: 0,
                    createdAt: new Date().toISOString(),
                    dateJoined: new Date().toISOString().split('T')[0],
                    lastLogin: new Date().toISOString(),
                    referralCode: referralCode,
                    referredBy: referredBy || '',
                    referrals: 0,
                    airtimeBalance: 0
                };
                
                // Save user data to Firebase
                return database.ref(`users/${userId}`).set(userData)
                    .then(() => {
                        // If user was referred, increment referral count for referrer
                        if (referredBy) {
                            // Find the user with this referral code
                            return database.ref('users').orderByChild('referralCode').equalTo(referredBy).once('value')
                                .then((snapshot) => {
                                    if (snapshot.exists()) {
                                        // Get the first match (should be only one)
                                        const referrerKey = Object.keys(snapshot.val())[0];
                                        // Increment referrals count
                                        return database.ref(`users/${referrerKey}`).child('referrals').transaction(count => {
                                            return (count || 0) + 1;
                                        });
                                    }
                                });
                        }
                    })
                    .then(() => {
                        // Update the user's display name in the authentication profile
                        return user.updateProfile({
                            displayName: fullName
                        });
                    })
                    .then(() => {
                        hideLoading('signup-button', 'signup-loading');
                        showSuccess('signup-success', 'Account created successfully! Redirecting to login...');
                        
                        // Redirect to login after 2 seconds
                        setTimeout(() => {
                            document.getElementById('tab-login').click();
                        }, 2000);
                    });
            })
            .catch((error) => {
                hideLoading('signup-button', 'signup-loading');
                let errorMessage = 'Sign up failed. Please try again.';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already in use';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak';
                }
                
                showError('signup-error', errorMessage);
            });
    });
});

// Forgot password functionality with verification
document.getElementById('forgot-button').addEventListener('click', () => {
    const email = document.getElementById('forgot-email').value;
    
    if (!email) {
        showError('forgot-error', 'Please enter your email address');
        return;
    }
    
    // Start verification before processing password reset
    startVerification(() => {
        showLoading('forgot-button', 'forgot-loading');
        
        auth.sendPasswordResetEmail(email)
            .then(() => {
                hideLoading('forgot-button', 'forgot-loading');
                showSuccess('forgot-success', 'Password reset email sent. Please check your inbox.');
                document.getElementById('forgot-email').value = '';
            })
            .catch((error) => {
                hideLoading('forgot-button', 'forgot-loading');
                let errorMessage = 'Failed to send reset email. Please try again.';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address';
                }
                
                showError('forgot-error', errorMessage);
            });
    });
});

// Check if user is already logged in on page load
auth.onAuthStateChanged(user => {
    if (user) {
        // Instead of redirecting, notify the parent window of the login
        notifyParentOfLogin(user);
    }
});

// Fix for the duplicate username variable in the original code
// This runs when the page loads to ensure we fix the signup functionality
document.addEventListener('DOMContentLoaded', () => {
    // Check if there was a duplicate username variable in the original code
    // by looking at the signup button click handler
    const signupButton = document.getElementById('signup-button');
    if (signupButton) {
        console.log('Ensuring signup functionality is properly initialized');
    }
});
</script>
</body>
</html>