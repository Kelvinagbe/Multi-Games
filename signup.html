<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Registration</title>
    <style>
        :root {
            --primary: #1a9e42;
            --primary-dark: #0e7c2e;
            --secondary: #555555;
            --text: #333333;
            --bg: #f5f5f5;
            --card-bg: #f5f5f5;
            --accent: #50e980;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: var(--text);
            min-height: 50vh;
            min-width: 0px;
            display: flex;
            align-items: flex;
            justify-content: center;
            padding: 0;

        }

        .container {
          width: 100%;
            max-width: 700px;
            margin: 0 auto;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            margin-bottom: 0px;
        }

        .form-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 0px;
            box-shadow: 0 4px 0px rgba(0, 0, 0, 0);
        }

        h1 {
            font-size: 24px;
            margin-bottom: 25px;
            text-align: center;
            color: var(--text);
        }

        .progress-container {
            margin-bottom: 25px;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
            box-shadow: 0 4px 5px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 20%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: var(--secondary);
            text-align: center;
        }

        .step-content {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .error-text {
            color: #e53935;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .checkbox-group input {
            width: auto;
            margin-right: 10px;
            margin-top: 3px;
         box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .password-requirements {
            margin-top: 15px;
        }

        .requirement-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .requirement-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #e0e0e0;
            margin-right: 10px;
            transition: background-color 0.3s;
        }

        .password-strength {
            margin-top: 10px;
        }

        .strength-bar-container {
            height: 5px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .strength-bar {
            height: 100%;
            width: 0;
            background-color: #e53935;
            transition: width 0.3s, background-color 0.3s;
        }

        .verification-timer {
            margin: 15px 0;
            display: none;
        }

        .timer-bar-container {
            height: 5px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .timer-bar {
            height: 100%;
            width: 100%;
            background-color: var(--primary);
            transition: width 0.3s;
        }

        .timer-text {
            font-size: 14px;
            text-align: center;
        }

        .captcha-container {
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
            flex: 1;
           box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: #e0e0e0;
            color: var(--text);
        }

        .btn-secondary:hover {
            background-color: #d0d0d0;
        }

        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-message {
            padding: 12px 15px;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            display: none;
            text-align: center;
        }

        .success-icon {
            font-size: 60px;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .success-text {
            color: var(--secondary);
            margin-bottom: 25px;
        }

        .email-highlight {
            font-weight: bold;
            color: var(--primary);
        }

        .resend-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .resend-link:hover {
            text-decoration: underline;
        }

        .social-login {
            margin-top: 30px;
            text-align: center;
        }

        .social-login-text {
            position: relative;
            margin-bottom: 20px;
        }

        .social-login-text::before,
        .social-login-text::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 35%;
            height: 1px;
            background-color: #e0e0e0;
        }

        .social-login-text::before {
            left: 0;
        }

        .social-login-text::after {
            right: 0;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            width: 100%;
        }

        .google-btn:hover {
            background-color: #f5f5f5;
        }

        .google-icon {
            margin-right: 10px;
        }

        .hidden {
            display: none;
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Add Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- Add Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Add Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Google reCAPTCHA API -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    
       
        
        <div class="form-card">
            <form id="registration-form">
                <h1>Create Account</h1>
                
                <div class="progress-container">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <div class="progress-text">Step <span id="current-step">1</span> of 5</div>
                </div>
                
                <div id="status-message" class="status-message"></div>
                
                <!-- Step 1: Full Name -->
                <div id="step-1" class="step-content">
                    <div class="form-group">
                        <label for="fullname">Full Name</label>
                        <input type="text" id="fullname" name="fullname" placeholder="Enter your full name">
                        <div id="fullname-error" class="error-text"></div>
                    </div>
                </div>
                
                <!-- Step 2: Username -->
                <div id="step-2" class="step-content hidden">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" placeholder="Choose a username">
                        <div id="username-error" class="error-text"></div>
                    </div>
                </div>
                
                <!-- Step 3: Email -->
                <div id="step-3" class="step-content hidden">
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" placeholder="Enter your email">
                        <div id="email-error" class="error-text"></div>
                    </div>
                    <div class="form-group">
                        <label for="referralCode">Referral Code (Optional)</label>
                        <input type="text" id="referralCode" name="referralCode" placeholder="Enter referral code if you have one">
                    </div>
                </div>
                
                <!-- Step 4: Password -->
                <div id="step-4" class="step-content hidden">
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" placeholder="Create a strong password">
                        
                        <div class="password-requirements">
                            <div class="requirement-item">
                                <div class="requirement-indicator" id="req-length"><div></div></div>
                                <span>At least 8 characters</span>
                            </div>
                            <div class="requirement-item">
                                <div class="requirement-indicator" id="req-uppercase"><div></div></div>
                                <span>At least one uppercase letter</span>
                            </div>
                            <div class="requirement-item">
                                <div class="requirement-indicator" id="req-lowercase"><div></div></div>
                                <span>At least one lowercase letter</span>
                            </div>
                            <div class="requirement-item">
                                <div class="requirement-indicator" id="req-number"><div></div></div>
                                <span>At least one number</span>
                            </div>
                            <div class="requirement-item">
                                <div class="requirement-indicator" id="req-special"><div></div></div>
                                <span>At least one special character</span>
                            </div>
                        </div>
                        
                        <div class="password-strength">
                            <div class="strength-bar-container">
                                <div class="strength-bar" id="password-strength-bar"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm your password">
                        <div id="confirm-password-error" class="error-text"></div>
                    </div>
                </div>
                
                <!-- Step 5: Terms and CAPTCHA -->
                <div id="step-5" class="step-content hidden">
                    <div class="checkbox-group">
                        <input type="checkbox" id="terms" name="terms">
                        <label for="terms">I agree to the <a href="#" target="_blank">Terms of Service</a> and <a href="#" target="_blank">Privacy Policy</a></label>
                    </div>
                    <div id="terms-error" class="error-text"></div>
                    
                    <div class="captcha-container">
                        <button type="button" id="captcha-button" class="btn btn-secondary">Click to verify captcha</button>
                        <div id="verification-timer" class="verification-timer">
                            <div class="timer-bar-container">
                                <div class="timer-bar" id="timer-bar"></div>
                            </div>
                            <div class="timer-text">Verifying... <span id="timer-seconds">5</span> seconds remaining</div>
                        </div>
                        <div id="g-recaptcha" data-sitekey="6LcUC_0qAAAAAO9Aa5ydOLmbp2_ymtNJlj9v3ZfF"></div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="button" id="prev-button" class="btn btn-secondary hidden">Previous</button>
                    <button type="button" id="next-button" class="btn btn-primary">Next</button>
                    <button type="submit" id="submit-button" class="btn btn-primary hidden">Create Account</button>
                </div>
            </form>
            
            <!-- Success Message -->
            <div id="success-message" class="success-message">
                <div class="success-icon">✓</div>
                <h2 class="success-title">Account Created!</h2>
                <p class="success-text">We've sent a verification email to <span id="user-email" class="email-highlight"></span>. Please check your inbox and verify your email to complete the registration.</p>
                <p>Didn't receive the email? <a id="resend-email-btn" class="resend-link">Resend verification email</a></p>
            </div>
        </div>

    <script>
       // Firebase configuration and initialization
const firebaseConfig = {
    apiKey: "AIzaSyBw1uA-kNKOZEufWKZ9AMBxvRGHNGF1lkA",
    authDomain: "multi-games-a2561.firebaseapp.com",
    projectId: "multi-games-a2561",
    storageBucket: "multi-games-a2561.appspot.com",
    messagingSenderId: "150551898066",
    appId: "1:150551898066:web:4e8fb185f2321ba4140a0b",
    measurementId: "G-PB8Y87E6XV",
    databaseURL: "https://multi-games-a2561-default-rtdb.firebaseio.com"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const rtdb = firebase.database();

// DOM Elements
const form = document.getElementById('registration-form');
const progressBar = document.getElementById('progress-bar');
const currentStepText = document.getElementById('current-step');
const prevButton = document.getElementById('prev-button');
const nextButton = document.getElementById('next-button');
const submitButton = document.getElementById('submit-button');
const statusMessage = document.getElementById('status-message');
const successMessage = document.getElementById('success-message');
const userEmailSpan = document.getElementById('user-email');
const resendEmailBtn = document.getElementById('resend-email-btn');
const captchaButton = document.getElementById('captcha-button');
const verificationTimer = document.getElementById('verification-timer');
const timerBar = document.getElementById('timer-bar');
const timerSeconds = document.getElementById('timer-seconds');
const verificationInfo = document.getElementById('verification-info');

// Form fields
const fullname = document.getElementById('fullname');
const username = document.getElementById('username');
const email = document.getElementById('email');
const referralCode = document.getElementById('referralCode');
const password = document.getElementById('password');
const confirmPassword = document.getElementById('confirmPassword');
const termsCheckbox = document.getElementById('terms');

// Password requirement indicators
const reqLength = document.getElementById('req-length');
const reqUppercase = document.getElementById('req-uppercase');
const reqLowercase = document.getElementById('req-lowercase');
const reqNumber = document.getElementById('req-number');
const reqSpecial = document.getElementById('req-special');
const passwordStrengthBar = document.getElementById('password-strength-bar');

// Error elements
const fullnameError = document.getElementById('fullname-error');
const usernameError = document.getElementById('username-error');
const emailError = document.getElementById('email-error');
const confirmPasswordError = document.getElementById('confirm-password-error');
const termsError = document.getElementById('terms-error');

// Variables
let currentStep = 1;
const totalSteps = 5;
let captchaVerified = false;
let timeoutId;
let timerInterval;
let currentUser = null;
let verificationCheckInterval = null;

// Check if Firebase Auth is properly configured for email verification
document.addEventListener('DOMContentLoaded', () => {
    console.log("Firebase Auth initialized:", auth);
    console.log("Firebase config:", firebaseConfig);
});

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    // Initialize form
    updateProgressBar();
    
    // Make sure success message is initially hidden
    if (successMessage) {
        successMessage.style.display = 'none';
    }
    
    // Button event listeners
    prevButton.addEventListener('click', goToPreviousStep);
    nextButton.addEventListener('click', goToNextStep);
    form.addEventListener('submit', handleSubmit);
    captchaButton.addEventListener('click', startCaptchaVerification);
    
    // Only add resendEmailBtn listener if the element exists
    if (resendEmailBtn) {
        resendEmailBtn.addEventListener('click', resendVerificationEmail);
    }
    
    // Google Sign In (only if element exists)
    const googleSignIn = document.getElementById('google-signin');
    if (googleSignIn) {
        googleSignIn.addEventListener('click', signInWithGoogle);
    }
    
    // Password validation
    password.addEventListener('input', validatePassword);
    confirmPassword.addEventListener('input', validateConfirmPassword);
    
    // Prevent form submission on enter key
    form.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (currentStep < totalSteps) {
                goToNextStep();
            } else {
                handleSubmit(e);
            }
        }
    });

    // Check if user is already logged in and verified
    auth.onAuthStateChanged(function(user) {
        if (user) {
            console.log("User is signed in:", user.email);
            console.log("Email verified status:", user.emailVerified);
            
            // User is signed in
            if (user.emailVerified) {
                console.log("User is verified, redirecting to dashboard");
                // User is verified, redirect to dashboard
                window.location.href = '/dashboard.html';
            } else {
                console.log("User is signed in but not verified");
                // Optionally: Show verification reminder if user is logged in but not verified
                if (document.getElementById('verification-reminder')) {
                    document.getElementById('verification-reminder').style.display = 'block';
                }
            }
        } else {
            console.log("No user is signed in");
        }
    });
    
    // Alert for debugging Firebase initialization
    console.log("Firebase initialized with authentication:", !!auth);
    console.log("Firebase initialized with firestore:", !!db);
    console.log("Firebase initialized with realtime database:", !!rtdb);
});

// Functions
function updateProgressBar() {
    const progress = (currentStep / totalSteps) * 100;
    progressBar.style.width = `${progress}%`;
    currentStepText.textContent = currentStep;
    
    // Show/hide appropriate step
    for (let i = 1; i <= totalSteps; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        if (i === currentStep) {
            stepElement.classList.remove('hidden');
        } else {
            stepElement.classList.add('hidden');
        }
    }
    
    // Update buttons
    if (currentStep === 1) {
        prevButton.classList.add('hidden');
    } else {
        prevButton.classList.remove('hidden');
    }
    
    if (currentStep === totalSteps) {
        nextButton.classList.add('hidden');
        submitButton.classList.remove('hidden');
    } else {
        nextButton.classList.remove('hidden');
        submitButton.classList.add('hidden');
    }
}

function goToPreviousStep() {
    if (currentStep > 1) {
        currentStep--;
        updateProgressBar();
    }
}

function goToNextStep() {
    if (validateCurrentStep()) {
        if (currentStep < totalSteps) {
            currentStep++;
            updateProgressBar();
        }
    }
}

function validateCurrentStep() {
    clearErrors();
    
    switch (currentStep) {
        case 1:
            // Validate full name
            if (!fullname.value.trim()) {
                showError(fullnameError, 'Please enter your full name');
                return false;
            }
            if (fullname.value.trim().length < 3) {
                showError(fullnameError, 'Name must be at least 3 characters');
                return false;
            }
            return true;
            
        case 2:
            // Validate username
            if (!username.value.trim()) {
                showError(usernameError, 'Please choose a username');
                return false;
            }
            if (username.value.trim().length < 4) {
                showError(usernameError, 'Username must be at least 4 characters');
                return false;
            }
            return checkUsernameAvailability();
            
        case 3:
            // Validate email
            if (!email.value.trim()) {
                showError(emailError, 'Please enter your email address');
                return false;
            }
            if (!isValidEmail(email.value.trim())) {
                showError(emailError, 'Please enter a valid email address');
                return false;
            }
            return checkEmailAvailability();
            
        case 4:
            // Validate password
            if (!password.value) {
                return false;
            }
            if (!confirmPassword.value) {
                showError(confirmPasswordError, 'Please confirm your password');
                return false;
            }
            if (password.value !== confirmPassword.value) {
                showError(confirmPasswordError, 'Passwords do not match');
                return false;
            }
            return true;
            
        default:
            return true;
    }
}

async function checkUsernameAvailability() {
    try {
        const usernameRef = await db.collection('usernames').doc(username.value.trim().toLowerCase()).get();
        
        if (usernameRef.exists) {
            showError(usernameError, 'Username already taken. Please choose another one.');
            return false;
        }
        
        return true;
    } catch (error) {
        console.error("Error checking username:", error);
        showError(usernameError, 'Error checking username availability. Please try again.');
        return false;
    }
}

async function checkEmailAvailability() {
    try {
        const result = await auth.fetchSignInMethodsForEmail(email.value.trim());
        
        if (result && result.length > 0) {
            showError(emailError, 'This email is already registered. Please use another email or try logging in.');
            return false;
        }
        
        return true;
    } catch (error) {
        console.error("Error checking email:", error);
        
        if (error.code === 'auth/invalid-email') {
            showError(emailError, 'Please enter a valid email address');
        } else {
            showError(emailError, 'Error checking email availability. Please try again.');
        }
        
        return false;
    }
}

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function validatePassword() {
    const value = password.value;
    
    // Check requirements
    const hasLength = value.length >= 8;
    const hasUppercase = /[A-Z]/.test(value);
    const hasLowercase = /[a-z]/.test(value);
    const hasNumber = /[0-9]/.test(value);
    const hasSpecial = /[^A-Za-z0-9]/.test(value);
    
    // Update indicators
    updateRequirementIndicator(reqLength, hasLength);
    updateRequirementIndicator(reqUppercase, hasUppercase);
    updateRequirementIndicator(reqLowercase, hasLowercase);
    updateRequirementIndicator(reqNumber, hasNumber);
    updateRequirementIndicator(reqSpecial, hasSpecial);
    
    // Calculate strength
    let strength = 0;
    if (hasLength) strength += 20;
    if (hasUppercase) strength += 20;
    if (hasLowercase) strength += 20;
    if (hasNumber) strength += 20;
    if (hasSpecial) strength += 20;
    
    // Update strength bar
    passwordStrengthBar.style.width = `${strength}%`;
    
    // Color based on strength
    if (strength < 40) {
        passwordStrengthBar.style.backgroundColor = '#e53935'; // Weak (red)
    } else if (strength < 80) {
        passwordStrengthBar.style.backgroundColor = '#ffb300'; // Medium (amber)
    } else {
        passwordStrengthBar.style.backgroundColor = '#43a047'; // Strong (green)
    }
    
    validateConfirmPassword();
}

function validateConfirmPassword() {
    if (confirmPassword.value && password.value !== confirmPassword.value) {
        showError(confirmPasswordError, 'Passwords do not match');
        return false;
    } else {
        confirmPasswordError.style.display = 'none';
        return true;
    }
}

function updateRequirementIndicator(element, fulfilled) {
    if (fulfilled) {
        element.style.backgroundColor = '#43a047'; // Green
    } else {
        element.style.backgroundColor = '#e0e0e0'; // Grey
    }
}

function showError(element, message) {
    element.textContent = message;
    element.style.display = 'block';
}

function clearErrors() {
    const errorElements = document.querySelectorAll('.error-text');
    errorElements.forEach(element => {
        element.style.display = 'none';
    });
    
    statusMessage.style.display = 'none';
}

function showStatusMessage(message, isError = false) {
    statusMessage.textContent = message;
    statusMessage.style.display = 'block';
    statusMessage.style.backgroundColor = isError ? '#ffebee' : '#e8f5e9';
    statusMessage.style.color = isError ? '#c62828' : '#2e7d32';
    statusMessage.style.border = `1px solid ${isError ? '#ef9a9a' : '#a5d6a7'}`;
    
    // Auto-hide after 5 seconds
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
        statusMessage.style.display = 'none';
    }, 5000);
}

function startCaptchaVerification() {
    // For a real implementation, you should use reCAPTCHA or similar
    captchaButton.style.display = 'none';
    verificationTimer.style.display = 'block';
    
    let secondsLeft = 5;
    timerSeconds.textContent = secondsLeft;
    
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        secondsLeft--;
        timerSeconds.textContent = secondsLeft;
        timerBar.style.width = `${(secondsLeft / 5) * 100}%`;
        
        if (secondsLeft <= 0) {
            clearInterval(timerInterval);
            captchaVerified = true;
            verificationTimer.style.display = 'none';
            captchaButton.style.display = 'block';
            captchaButton.textContent = '✓ Verification Complete';
            captchaButton.disabled = true;
            captchaButton.classList.add('disabled');
        }
    }, 1000);
}

async function handleSubmit(e) {
    e.preventDefault();
    
    if (!validateCurrentStep()) {
        return;
    }
    
    // Validate terms
    if (!termsCheckbox.checked) {
        showError(termsError, 'You must agree to the Terms of Service and Privacy Policy');
        return;
    }
    
    // Validate captcha
    if (!captchaVerified) {
        showStatusMessage('Please complete the verification first', true);
        return;
    }
    
    // Show loading state
    submitButton.disabled = true;
    submitButton.textContent = 'Creating Account...';
    showStatusMessage('Creating your account...');
    
    try {
        // Create user in Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(email.value.trim(), password.value);
        currentUser = userCredential.user;
        
        // Update profile with display name
        await currentUser.updateProfile({
            displayName: fullname.value.trim()
        });
        
        // IMPORTANT: Send email verification - simplified approach
        await currentUser.sendEmailVerification();
        console.log("Verification email sent to:", email.value.trim());
        
        // Reserve username in a separate collection for quick lookup
        await db.collection('usernames').doc(username.value.trim().toLowerCase()).set({
            uid: currentUser.uid
        });
        
        // Store user data in Firestore
        await db.collection('users').doc(currentUser.uid).set({
            fullName: fullname.value.trim(),
            username: username.value.trim(),
            email: email.value.trim(),
            referralCode: referralCode.value.trim() || null,
            emailVerified: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Set initial airtime balance in Realtime Database
        await rtdb.ref(`users/${currentUser.uid}/wallet`).set({
            airtimeBalance: 0,
            lastUpdated: firebase.database.ServerValue.TIMESTAMP
        });
        
        console.log("Registration successful, showing success message");
        
        // FIXED: Ensure form is properly hidden with important flag
        form.style.display = 'none !important';
        
        // FIXED: Force success message to be visible with !important
        if (successMessage) {
            successMessage.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            userEmailSpan.textContent = email.value.trim();
        }
        
        // Start checking for email verification
        startVerificationCheck();
        
    } catch (error) {
        console.error('Error during registration:', error);
        let errorMessage = 'An error occurred during registration.';
        
        if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'This email is already registered. Please use a different email or try logging in.';
        } else if (error.code === 'auth/weak-password') {
            errorMessage = 'Password is too weak. Please choose a stronger password.';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'The email address is invalid.';
        } else if (error.code === 'auth/operation-not-allowed') {
            errorMessage = 'Email/password accounts are not enabled. Please contact support.';
        } else if (error.code === 'auth/network-request-failed') {
            errorMessage = 'Network error. Please check your internet connection and try again.';
        }
        
        showStatusMessage(errorMessage, true);
        submitButton.disabled = false;
        submitButton.textContent = 'Create Account';
    }
}

function startVerificationCheck() {
    // FIXED: Make sure verification info is visible
    if (verificationInfo) {
        verificationInfo.innerHTML = `
            <h3>Verification Email Sent</h3>
            <p>A verification link has been sent to <strong>${email.value.trim()}</strong></p>
            <p>Please check your inbox (and spam folder) and click the verification link to activate your account.</p>
            <p>Once verified, you'll be able to log in and use all features.</p>
            <p><strong>Note:</strong> If you don't see the email, please check your spam folder. The email will come from <em>noreply@[your-firebase-project-id].firebaseapp.com</em>.</p>
        `;
        verificationInfo.style.cssText = 'display: block !important; visibility: visible !important;';
    }
    
    // FIXED: Update success message with verification details and ensure visibility
    if (successMessage) {
        successMessage.innerHTML = `
            <h2>Account Created Successfully!</h2>
            <p>Your account has been created but requires email verification before you can log in.</p>
            <p>We've sent a verification link to <span id="user-email">${email.value.trim()}</span></p>
            <p>Please check your inbox (including spam folder) and click the verification link.</p>
            <p>If you didn't receive the email, you can <button id="resend-email-btn" class="btn">Resend Verification Email</button></p>
        `;
        successMessage.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
    }
    
    // Re-attach the event listener since we replaced the HTML
    const newResendBtn = document.getElementById('resend-email-btn');
    if (newResendBtn) {
        newResendBtn.addEventListener('click', resendVerificationEmail);
    }
    
    // Check every 5 seconds if the email has been verified
    clearInterval(verificationCheckInterval);
    verificationCheckInterval = setInterval(async () => {
        if (currentUser) {
            try {
                // Log for debugging
                console.log("Checking if email is verified...");
             // Reload the user to get fresh emailVerified property
                await currentUser.reload();
                console.log("User emailVerified status:", currentUser.emailVerified);
                
                if (currentUser.emailVerified) {
                    clearInterval(verificationCheckInterval);
                    
                    // Update the user record in Firestore
                    await db.collection('users').doc(currentUser.uid).update({
                        emailVerified: true
                    });
                    
                    // Show verified message
                    if (verificationInfo) {
                        verificationInfo.innerHTML = `
                            <h3>Email Verified!</h3>
                            <p>Your email has been successfully verified.</p>
                            <p>You will be redirected to the login page in 5 seconds...</p>
                        `;
                    }
                    
                    // Success message update
                    if (successMessage) {
                        successMessage.innerHTML = `
                            <h2>Email Verified Successfully!</h2>
                            <p>Your account has been fully activated.</p>
                            <p>You will be redirected to the login page in 5 seconds.</p>
                        `;
                    }
                    
                    // Redirect after 5 seconds
                    setTimeout(() => {
                        window.location.href = '/login.html?verified=true';
                    }, 5000);
                }
            } catch (error) {
                console.error("Error checking verification status:", error);
            }
        }
    }, 5000); // Check every 5 seconds
}

async function resendVerificationEmail() {
    try {
        const resendEmailBtn = document.getElementById('resend-email-btn');
        if (resendEmailBtn) {
            resendEmailBtn.disabled = true;
            resendEmailBtn.textContent = 'Sending...';
        }
        
        if (currentUser) {
            // Simple approach without additional options
            await currentUser.sendEmailVerification();
            console.log("Resent verification email to:", currentUser.email);
            
            showStatusMessage('Verification email resent successfully!');
            
            // Update button state
            if (resendEmailBtn) {
                resendEmailBtn.textContent = 'Email Sent';
                setTimeout(() => {
                    resendEmailBtn.disabled = false;
                    resendEmailBtn.textContent = 'Resend Verification Email';
                }, 60000); // Re-enable after 1 minute
            }
            
        } else {
            // If user refreshed page and lost currentUser reference
            const user = auth.currentUser;
            if (user) {
                // Simple approach without additional options
                await user.sendEmailVerification();
                console.log("Resent verification email to:", user.email);
                
                showStatusMessage('Verification email resent successfully!');
                
                // Update button state
                if (resendEmailBtn) {
                    resendEmailBtn.textContent = 'Email Sent';
                    setTimeout(() => {
                        resendEmailBtn.disabled = false;
                        resendEmailBtn.textContent = 'Resend Verification Email';
                    }, 60000); // Re-enable after 1 minute
                }
                
            } else {
                showStatusMessage('Error: Cannot resend verification email. Please try registering again.', true);
                if (resendEmailBtn) {
                    resendEmailBtn.disabled = false;
                    resendEmailBtn.textContent = 'Resend Verification Email';
                }
            }
        }
    } catch (error) {
        console.error('Error resending verification email:', error);
        showStatusMessage(`Error resending verification email: ${error.message}`, true);
        const resendEmailBtn = document.getElementById('resend-email-btn');
        if (resendEmailBtn) {
            resendEmailBtn.disabled = false;
            resendEmailBtn.textContent = 'Resend Verification Email';
        }
    }
}

function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    
    auth.signInWithPopup(provider)
        .then(async (result) => {
            const user = result.user;
            const isNewUser = result.additionalUserInfo.isNewUser;
            
            if (isNewUser) {
                try {
                    // Create a username based on display name
                    const baseUsername = user.displayName
                        .toLowerCase()
                        .replace(/\s+/g, '')
                        .replace(/[^a-z0-9]/gi, '')
                        .substring(0, 15);
                    
                    let username = baseUsername;
                    let counter = 1;
                    let usernameAvailable = false;
                    
                    // Check username availability and add number if needed
                    while (!usernameAvailable) {
                        const usernameDoc = await db.collection('usernames').doc(username).get();
                        
                        if (!usernameDoc.exists) {
                            usernameAvailable = true;
                        } else {
                            username = `${baseUsername}${counter}`;
                            counter++;
                        }
                    }
                    
                    // Reserve username
                    await db.collection('usernames').doc(username).set({
                        uid: user.uid
                    });
                    
                    // Store user data in Firestore for new Google users
                    await db.collection('users').doc(user.uid).set({
                        fullName: user.displayName,
                        username: username,
                        email: user.email,
                        photoURL: user.photoURL || null,
                        emailVerified: user.emailVerified,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        authProvider: 'google'
                    });
                    
                    // Set initial airtime balance in Realtime Database
                    await rtdb.ref(`users/${user.uid}/wallet`).set({
                        airtimeBalance: 0,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // Redirect to onboarding for new users
                    window.location.href = '/onboarding.html';
                    
                } catch (error) {
                    console.error('Error setting up Google user:', error);
                    showStatusMessage('Error creating account. Please try again.', true);
                }
            } else {
                // Redirect existing users to dashboard
                window.location.href = '/dashboard.html';
            }
        })
        .catch((error) => {
            console.error('Google sign-in error:', error);
            showStatusMessage('Error signing in with Google. Please try again.', true);
        });
}
</script>
</body>
</html>